-- Header be gone! Moved to togapack.json.
-- This version is for BetterCalc!

sendInfoMessage("Hello World! Starting TOGAPack...", "TOGAPack")

-- Define thy map.
SMODS.Atlas{key = "TOGAJokersMain", path = "togajokers.png", px = 72, py = 95}
SMODS.Atlas{key = "TOGAJokersOther", path = "togajokersother.png", px = 71, py = 95}
SMODS.Atlas{key = "TOGAJokersWindows", path = "togajokerswinos.png", px = 72, py = 95}
SMODS.Atlas{key = "TOGAJokersUpdate", path = "togajokerupdate.png", px = 72, py = 95}
SMODS.Atlas{key = "TOGAJokerRover", path = "togarover.png", px = 71, py = 95}
SMODS.Atlas{key = "TOGABoosterPack", path = "togabooster.png", px = 71, py = 95}
SMODS.Atlas{key = "TOGAConsumables", path = "togacons.png", px = 71, py = 95}
SMODS.Atlas{key = "TOGADeckBack", path = "togadeck.png", px = 71, py = 95}
SMODS.Atlas{key = "TOGATags", path = "togatags.png", px = 34, py = 34}
SMODS.Atlas{key = "TOGASeals", path = "togaseal.png", px = 71, py = 95}
SMODS.Atlas{key = "TOGAEnhancements", path = "togaenh.png", px = 71, py = 95}
SMODS.Atlas{key = "modicon", path = "togaicon.png", px = 32, py = 32}

-- Hear me scream!
SMODS.Sound({key = "win95start", path = "win95start.ogg"}) -- The Microsoft Sound (95 & NT4)
SMODS.Sound({key = "win95tada", path = "win95tada.ogg"}) -- tada.wav (3.x, 95 & NT4)
SMODS.Sound({key = "chordold", path = "chordold.wav"}) -- chord.wav (95 & NT4)
SMODS.Sound({key = "chord", path = "chord.wav"}) -- chord.wav (98, ME, 2000 and XP)
SMODS.Sound({key = "win98start", path = "win98start.ogg"}) -- The Microsoft Sound (98) [edited]
SMODS.Sound({key = "win98tada", path = "win98tada.ogg"}) -- tada.wav (98, ME, 2000 and XP)
SMODS.Sound({key = "winme2000start", path = "winmestart.ogg"}) -- Windows Logon Sound for ME/2000 [edited]
SMODS.Sound({key = "winme2000shutdown", path = "winmeshutdown.ogg"}) -- Windows Logoff Sound for ME/2000 [edited]
SMODS.Sound({key = "winnt4start", path = "winnt4start.ogg"}) -- Windows Logon Sound for NT4 [edited]
SMODS.Sound({key = "winnt4shutdown", path = "winnt4shutdown.ogg"}) -- Windows Logoff Sound for NT4 [edited]
SMODS.Sound({key = "winxplogon", path = "Windows XP Logon Sound.wav"}) -- Windows Logon Sound, XP
SMODS.Sound({key = "winxplogoff", path = "Windows XP Logoff Sound.wav"}) -- Windows Logoff Sound, XP
SMODS.Sound({key = "winxpyesyoucan", path = "theexperience.ogg"}) -- Snippet from Windows XP Tour
SMODS.Sound({key = "winxpcritstop", path = "Windows XP Critical Stop.wav"}) -- Critical Stop, XP
SMODS.Sound({key = "winxpballoon", path = "Windows XP Balloon.wav"}) -- Critical Stop, XP
SMODS.Sound({key = "ssb64crowdohh", path = "Crowd Ohhh.ogg"}) -- Crowd Ohhh from Super Smash Bros 64
SMODS.Sound({key = "duck", path = "duck.ogg"}) -- Mac OS 9 Quack
SMODS.Sound({key = "kcud", path = "kcud.ogg"}) -- kcauQ 9 SO caM
SMODS.Sound({key = "ie31", path = "1.wav"}) -- Internet Explorer 3 Administration Kit Autorun
SMODS.Sound({key = "access97", path = "Microsoft Access 97 Sound.wav"}) -- Microsoft Access 97
SMODS.Sound({key = "recyclebinsfx", path = "recycle.ogg"}) -- recycle.wav (98, ME, 2000) 
SMODS.Sound({key = "plus98emptybin", path = "WI_EMPTY.WAV"}) -- Plus! 98, Windows 98 Empty Recycle Bin
SMODS.Sound({key = "infraredbegin", path = "ir_begin.ogg"}) -- Infrared Begin (starting infrared activity?)
SMODS.Sound({key = "infraredend", path = "ir_end.ogg"}) -- Infrared End (ending infrared activity?)
SMODS.Sound({key = "o97doorbell", path = "doorbell.wav"}) -- doorbell.wav from Office 97 Multimedia
SMODS.Sound({key = "o97glide", path = "glide.wav"}) -- glide.wav from Office 97 Multimedia
SMODS.Sound({key = "mmeclap", path = "CLAP.WAV"}) -- clap.wav from Windows 3.0 MME
SMODS.Sound({key = "officehammer", path = "HAMMER.WAV"}) -- hammer.wav from Microsoft Office sounds
SMODS.Sound({key = "mscmenucmd", path = "Musica Menu Command.ogg"}) -- Musica Sound Scheme (95 & NT4)
SMODS.Sound({key = "spb", path = "kc57.ogg"}) -- Unused in Knuckles Chaotix, Self-Propelled Bomb targeting first place in SRB2Kart/Dr. Robotnik's Ring Racers.
SMODS.Sound({key = "thundershield", path = "DSZIO3.ogg"}) -- Thunder Shield
SMODS.Sound({key = "anviluse", path = "mcanviluse.ogg"}) -- Snippet of block.anvil.use.
SMODS.Sound({key = "pinballstart", path = "SOUND4.WAV"}) -- Round Start, Plus! 98 - Space Cadet Pinball Demo
SMODS.Sound({key = "pinballloseball", path = "SOUND27.WAV"}) -- Lose Ball, Plus! 98 - Space Cadet Pinball Demo
SMODS.Sound({key = "rosenclick", path = "rosenclick.ogg"}) -- *click* Nice. - Michael Rosen
SMODS.Sound({key = "rosenhello", path = "rosenhello.ogg"}) -- self explanatory, same as above.
SMODS.Sound({key = "rosenbye", path = "rosenthatsashame.ogg"}) -- self explanatory, same as above.
SMODS.Sound({key = "rosenah", path = "rosenah.ogg"}) -- self explanatory, same as above.
SMODS.Sound({key = "scalesofjustice", path = "ScalesOfJustice.wav"}) -- self explanatory, Worms Armageddon/World Party.

-- I command you to execute.
SMODS.Sound({key = "win95pluscmd1", path = "plus95/Dangerous Creatures menu command.ogg"})
SMODS.Sound({key = "win95pluscmd2", path = "plus95/Inside your Computer menu command.ogg"})
SMODS.Sound({key = "win95pluscmd3", path = "plus95/Jungle menu command.ogg"})
SMODS.Sound({key = "win95pluscmd4", path = "plus95/Leonardo da Vinci menu command.ogg"})
SMODS.Sound({key = "win95pluscmd5", path = "plus95/Mystery menu command.ogg"})
SMODS.Sound({key = "win95pluscmd6", path = "plus95/Nature menu command.ogg"})
SMODS.Sound({key = "win95pluscmd7", path = "plus95/Science menu command.ogg"})
SMODS.Sound({key = "win95pluscmd8", path = "plus95/Space menu command.ogg"})
SMODS.Sound({key = "win95pluscmd9", path = "plus95/Sports menu command.ogg"})
SMODS.Sound({key = "win95pluscmd10", path = "plus95/The 60's USA menu command.ogg"})
SMODS.Sound({key = "win95pluscmd11", path = "plus95/The Golden Era menu command.ogg"})
SMODS.Sound({key = "win95pluscmd12", path = "plus95/Windows 95 menu command.ogg"})

-- Booster Pack content. So true.
SMODS.ObjectType{
	object_type = "ObjectType",
	key = "TOGAJKR",
	default = "j_toga_win95",
	cards = {
		["j_toga_y2kbug"] = true, ["j_toga_controlpanel"] = true, ["j_toga_mcanvil"] = true,
		["j_toga_taskmgr"] = true, ["j_toga_solitairejoker"] = true, ["j_toga_win95"] = true,
		["j_toga_win98"] = true, ["j_toga_winmillenium"] = true, ["j_toga_winnt4"] = true,
		["j_toga_win2000"] = true, ["j_toga_useraccounts"] = true, ["j_toga_virtualmemory"] = true,
		["j_toga_computerlock"] = true, ["j_toga_recyclebin"] = true, ["j_toga_theinternet"] = true,
		["j_toga_bonusducks"] = true, ["j_toga_spacecadetpinball"] = true, ["j_toga_jokersrb2kart"] = true,
		["j_toga_heartyspades"] = true, ["j_toga_systemrestore"] = true
	}
}

-- I think, therefore, I am.
togabalatro = SMODS.current_mod
togabalatro.config_tab = function() -- didn't expect it to be THIS convoluted... but other mods sure were going this route.
	return {n = G.UIT.ROOT, config = {r = 0.1, align = "cm", padding = 0.1, colour = G.C.BLACK, minw = 7, minh = 2}, nodes = {
		{n = G.UIT.R, config = {align = "cl", padding = 0}, nodes = {
			{n = G.UIT.C, config = { align = "cl", padding = 0.05 }, nodes = {
				create_toggle{ col = true, label = "", scale = 0.85, w = 0, shadow = true, ref_table = togabalatro.config, ref_value = "SFXWhenAdding" },
			}},
			{n = G.UIT.C, config = { align = "c", padding = 0 }, nodes = {
				{ n = G.UIT.T, config = { text = "SFX when getting some of the mods' Jokers", scale = 0.35, colour = G.C.UI.TEXT_LIGHT }},
			}},
		}},
		{n = G.UIT.R, config = {align = "cl", padding = 0}, nodes = {
			{n = G.UIT.C, config = { align = "cl", padding = 0.05 }, nodes = {
				create_toggle{ col = true, label = "", scale = 0.85, w = 0, shadow = true, ref_table = togabalatro.config, ref_value = "SFXWhenRemoving" },
			}},
			{n = G.UIT.C, config = { align = "c", padding = 0 }, nodes = {
				{ n = G.UIT.T, config = { text = "SFX when removing some of the mods' Jokers", scale = 0.35, colour = G.C.UI.TEXT_LIGHT }},
			}},
		}},
		{n = G.UIT.R, config = {align = "cl", padding = 0}, nodes = {
			{n = G.UIT.C, config = { align = "cl", padding = 0.05 }, nodes = {
				create_toggle{ col = true, label = "", scale = 0.85, w = 0, shadow = true, ref_table = togabalatro.config, ref_value = "SFXWhenTriggered" },
			}},
			{n = G.UIT.C, config = { align = "c", padding = 0 }, nodes = {
				{ n = G.UIT.T, config = { text = "SFX when some Jokers from this mod are triggered", scale = 0.35, colour = G.C.UI.TEXT_LIGHT }},
			}},
		}},
		{n = G.UIT.R, config = {align = "cl", padding = 0}, nodes = {
			{n = G.UIT.C, config = { align = "cl", padding = 0.05 }, nodes = {
				create_toggle{ col = true, label = "", scale = 0.85, w = 0, shadow = true, ref_table = togabalatro.config, ref_value = "JokeJokersActive" },
			}},
			{n = G.UIT.C, config = { align = "c", padding = 0 }, nodes = {
				{ n = G.UIT.T, config = { text = "Allow 'Joke' Jokers to appear in pool", scale = 0.35, colour = G.C.UI.TEXT_LIGHT }},
			}},
		}},
		{n = G.UIT.R, config = {align = "cl", padding = 0}, nodes = {
			{n = G.UIT.C, config = { align = "cl", padding = 0.05 }, nodes = {
				create_toggle{ col = true, label = "", scale = 0.85, w = 0, shadow = true, ref_table = togabalatro.config, ref_value = "DoMoreLogging" },
			}},
			{n = G.UIT.C, config = { align = "c", padding = 0 }, nodes = {
				{ n = G.UIT.T, config = { text = "Enable extra logs", scale = 0.35, colour = G.C.UI.TEXT_LIGHT }},
			}},
		}},
		{n = G.UIT.R, config = {align = "cl", padding = 0}, nodes = {
			{n = G.UIT.C, config = { align = "cl", padding = 0.05 }, nodes = {
				create_toggle{ col = true, label = "", scale = 0.85, w = 0, shadow = true, ref_table = togabalatro.config, ref_value = "Experimentals" },
			}},
			{n = G.UIT.C, config = { align = "c", padding = 0 }, nodes = {
				{ n = G.UIT.T, config = { text = "Enable Experimental objects", scale = 0.35, colour = G.C.UI.TEXT_LIGHT }},
			}},
		}},
	}}
end

togabalatro.description_loc_vars = function(self)
	return {
		scale = 1.25,
		text_colour = HEX('FFFFFF'),
		background_colour = HEX('2B2B2B')
	}
end

togabalatro.optional_features = function()
	return {
		cardareas = { deck = true },
		retrigger_joker = true
	}
end

local canplayref = G.FUNCS.can_play
G.FUNCS.can_play = function(e)
	canplayref(e) -- execute original first before we do anything.
	if #G.hand.highlighted <= G.hand.config.highlighted_limit then
		if #G.hand.highlighted >= 52 then -- Cryptid?
			e.config.colour = G.C.EDITION
			e.config.button = 'play_cards_from_highlighted'
		elseif #G.hand.highlighted >= 10 and #G.hand.highlighted < 52 then -- 2x the base.
			e.config.colour = G.C.DARK_EDITION
			e.config.button = 'play_cards_from_highlighted'
		elseif #G.hand.highlighted > 5 and #G.hand.highlighted < 10 then -- more than base.
			e.config.colour = G.C.PURPLE
			e.config.button = 'play_cards_from_highlighted'
		end
	end
end

-- As Talisman is now optional and we have some items using this, best keep this.
to_big = to_big or function(a)
	return a
end

local function toga_randompitch()
	local genvalue = math.random(50, 150)/100
	if togabalatro.config.DoMoreLogging then sendInfoMessage("Random pitch of "..genvalue.." returned.", "TOGAPack") end
	return genvalue
end

-- Check for 2 and King.
local function toga_y2kcheck(context)
	local twopresent = 0
	local kingpresent = 0
	for i = 1, #context.full_hand do
		if SMODS.Ranks[context.full_hand[i].base.value].key == "2" then
			twopresent = twopresent+1
		end
		if SMODS.Ranks[context.full_hand[i].base.value].key == "King" then
			kingpresent = kingpresent+1
		end
	end
	return twopresent, kingpresent
end

local rosensfxtable = { chips1 = true, multhit1 = true, multhit2 = true, coin1 = true, generic1 = true, foil2 = true, xchips = true,
						talisman_xchip = true, talisman_echip = true, talisman_eechip = true, talisman_eeechip = true,
						talisman_emult = true, talisman_eemult = true, talisman_eeemult = true }

local playsoundref = play_sound
function play_sound(sound_code, per, vol)
	if togabalatro.config.SFXWhenTriggered and next(SMODS.find_card('j_toga_michaelrosen')) and rosensfxtable[sound_code] then sound_code = 'toga_rosenclick' end
	
	playsoundref(sound_code, per, vol)
end

-- Y2K Sticker yoink.
local isfaceref = Card.is_face
function Card:is_face(from_boss)
    if self.debuff and not from_boss then return end
    local id = self:get_id()
    if next(SMODS.find_card('j_toga_y2ksticker')) and id == 2 or next(find_joker("Pareidolia")) then
        return true
    end
	return isfaceref(self, from_boss)
end

-- Hexa & Binary Joker yoink.
local getidref = Card.get_id
function Card:get_id()
	local id = getidref(self) or 2
	if next(SMODS.find_card('j_toga_hexadecimaljkr')) and id == 14 then id = 10 end
	if next(SMODS.find_card('j_toga_binaryjkr')) and id == 10 then id = 2 end
	return id
end

-- This still feels hacky, tbh.
local issuitref = Card.is_suit
function Card:is_suit(suit, bypass_debuff, flush_calc)
	if flush_calc then
		if next(SMODS.find_card('j_toga_heartyspades')) and next(SMODS.find_card('j_smeared'))
		and (self.base.suit == 'Hearts' or self.base.suit == 'Spades' or self.base.suit == 'Diamonds' or self.base.suit == 'Clubs') and (suit == 'Hearts' or suit == 'Spades' or suit == 'Diamonds' or suit == 'Clubs')
		and not SMODS.has_no_rank(self) then
			if togabalatro.config.DoMoreLogging then sendInfoMessage("Hearty Spades + Smeared Joker flush pass.", "TOGAPack") end
			return true
		end
		if next(SMODS.find_card('j_toga_heartyspades')) and (self.base.suit == 'Hearts' or self.base.suit == 'Spades') and (suit == 'Hearts' or suit == 'Spades')
		and not SMODS.has_no_rank(self) then
			if togabalatro.config.DoMoreLogging then sendInfoMessage("Hearty Spades flush pass.", "TOGAPack") end
			return true
		end
		return issuitref(self, suit, bypass_debuff, flush_calc)
	else
		if self.debuff and not bypass_debuff then return end
		if next(SMODS.find_card('j_toga_heartyspades')) and next(SMODS.find_card('j_smeared'))
		and (self.base.suit == 'Hearts' or self.base.suit == 'Spades' or self.base.suit == 'Diamonds' or self.base.suit == 'Clubs') and (suit == 'Hearts' or suit == 'Spades' or suit == 'Diamonds' or suit == 'Clubs')
		and not SMODS.has_no_rank(self) then
			if togabalatro.config.DoMoreLogging then sendInfoMessage("Hearty Spades + Smeared Joker pass.", "TOGAPack") end
			return true
		end
		if next(SMODS.find_card('j_toga_heartyspades')) and (self.base.suit == 'Hearts' or self.base.suit == 'Spades') and (suit == 'Hearts' or suit == 'Spades')
		and not SMODS.has_no_rank(self) then
			if togabalatro.config.DoMoreLogging then sendInfoMessage("Hearty Spades pass.", "TOGAPack") end
			return true
		end
		return issuitref(self, suit, bypass_debuff, flush_calc)
	end
end

SMODS.Joker{
	key = 'y2kbug',
	config = { extra = { chips = 25, mult = 4 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.chips, card.ability.extra.mult } }
	end,
	unlocked = true,
	discovered = true,
	rarity = 1,
	atlas = 'TOGAJokersMain',
	pos = { x = 1, y = 0 },
	cost = 4,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.individual and context.cardarea == G.play then
			local twos, kings = toga_y2kcheck(context)
			if twos > 0 and kings > 0 then
				return {chips = card.ability.extra.chips, mult = card.ability.extra.mult}
			end
		end
	end
}

SMODS.Joker{
	key = 'controlpanel',
	config = { extra = { money = 1, increase = 0.5, totalmoney = 7 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.money, card.ability.extra.increase, math.ceil(card.ability.extra.totalmoney) } }
	end,
	unlocked = true,
	rarity = 2,
	atlas = 'TOGAJokersMain',
	pos = { x = 1, y = 1 },
	cost = 7,
	blueprint_compat = false,
	calculate = function(self, card, context)
		if context.end_of_round and not (context.individual or context.repetition or context.blueprint) and G.GAME.blind.boss then
			card.ability.extra.money = card.ability.extra.money + card.ability.extra.increase
			card_eval_status_text(card, 'extra', nil, nil, nil, {message = localize('k_upgrade_ex')})
		end
	end,
	calc_dollar_bonus = function(self, card)
		if card.ability.extra.money > 0 then
			local jokerslotbonus, consslotbonus = 0, 0
			if G.jokers then jokerslotbonus = card.ability.extra.money*G.jokers.config.card_limit end
			if G.consumeables then consslotbonus = card.ability.extra.money*G.consumeables.config.card_limit end
			card.ability.extra.totalmoney = jokerslotbonus+consslotbonus
			return math.ceil(card.ability.extra.totalmoney)
		end
	end
}

SMODS.Joker{
	key = 'taskmgr',
	config = { extra = { money = 1, wiggling = false } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.money } }
	end,
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersMain',
	pos = { x = 0, y = 1 },
	cost = 8,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if G.GAME.current_round.discards_left == 2 then
			local eval = function() return G.GAME.current_round.discards_left == 1 end
			juice_card_until(card, eval, true)
		end
		
		if context.discard and not context.blueprint then
			if G.GAME.current_round.discards_left == 1 then
				return {
					remove = true,
					card = context.other_card
				}
			end
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_infraredbegin")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_infraredend")
		end
	end
}

-- Add up our 4 values and divide by 4 for their average.
local function toga_multaverage(card)
	local hleft, dleft, jslots, cslots = G.GAME.current_round.hands_left or 4, G.GAME.current_round.discards_left or 3, G.jokers and G.jokers.config.card_limit or 5, G.consumeables and G.consumeables.config.card_limit or 2
	card.ability.extra.baseXmult = math.max(card.ability.extra.baseXmult, 1)
	local averagecalc = (hleft+dleft+jslots+cslots)/4
	return math.max(card.ability.extra.baseXmult * averagecalc, card.ability.extra.baseXmult, 1)
end

-- Was previously Task Manager.
SMODS.Joker{
	key = 'useraccounts',
	config = { extra = { baseXmult = 1, totalXmult = 1, odds = 4 } },
	loc_vars = function(self, info_queue, card)
		if self.discovered then
			info_queue[#info_queue + 1] = {key = "toga_useraccountsinfo", set = 'Other'}
		end
		return { vars = { card.ability.extra.totalXmult, (G.GAME and G.GAME.probabilities.normal or 1), card.ability.extra.odds } }
	end,
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersMain',
	pos = { x = 1, y = 3 },
	cost = 8,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.cardarea == G.jokers and context.before then
			card.ability.extra.totalXmult = toga_multaverage(card)
		end
		
		if context.individual and context.cardarea == G.play then
			if context.other_card and pseudorandom("toga_useraccounts") < G.GAME.probabilities.normal/card.ability.extra.odds then
				return { x_mult = card.ability.extra.totalXmult }
			end
		end
	end,
	update = function(self, card, context)
		card.ability.extra.totalXmult = toga_multaverage(card)
	end
}

SMODS.Joker{
	key = 'virtualmemory',
	config = { extra = { odds = 4 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { (G.GAME and G.GAME.probabilities.normal or 1), card.ability.extra.odds } }
	end,
	unlocked = true,
	rarity = 2,
	atlas = 'TOGAJokersMain',
	pos = { x = 0, y = 3 },
	cost = 6,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.individual and context.cardarea == G.play then
			if pseudorandom("toga_virtualmemory") < G.GAME.probabilities.normal/card.ability.extra.odds then
				return {
					swap = true,
					message = localize('toga_pagefileuse'),
					colour = G.C.PURPLE,
					sound = not silent and togabalatro.config.SFXWhenTriggered and "toga_mmeclap",
					pitch = not silent and togabalatro.config.SFXWhenTriggered and toga_randompitch(),
					message_card = context.other_card
				}
			end
		end
	end,
}

SMODS.Joker{
	key = 'recyclebin',
	config = { extra = { xchip_increase = 0.05, xchip_mod = 1 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.xchip_increase, card.ability.extra.xchip_mod, card.ability.extra.xchip_increase*3 } }
	end,
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersMain',
	pos = { x = 2, y = 2 },
	cost = 12,
	blueprint_compat = true,
	calculate = function(self, card, context)
		local xchipval = card.ability.extra and card.ability.extra.xchip_mod or 1
		
		if context.individual and context.cardarea == G.play and xchipval > 1 then
			if context.other_card == context.scoring_hand[#context.scoring_hand] then
				return {
					x_chips = card.ability.extra.xchip_mod > 1 and card.ability.extra.xchip_mod or nil,
					xchip_message = card.ability.extra.xchip_mod > 1 and {message = localize{ type = "variable", key = "a_xchips", vars = { card.ability.extra.xchip_mod } }, colour = G.C.CHIPS, sound = "xchips"} or nil,
					card = card
				}
			end
		end
	
		if context.remove_playing_cards then
			for k, v in ipairs(context.removed) do
				if v.config.center ~= G.P_CENTERS.c_base then
					card.ability.extra.xchip_mod = card.ability.extra.xchip_mod+(card.ability.extra.xchip_increase*3)
				else
					card.ability.extra.xchip_mod = card.ability.extra.xchip_mod+card.ability.extra.xchip_increase
				end
			end
			card_eval_status_text(card, 'extra', nil, nil, nil, {message = localize('k_upgrade_ex'), sound = not silent and togabalatro.config.SFXWhenTriggered and "toga_recyclebinsfx"})
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_recyclebinsfx")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_plus98emptybin")
		end
	end,
	update = function(self, card, context)
		if card.ability.extra.xchip_mod < 1 then card.ability.extra.xchip_mod = 1 end
	end
}

SMODS.Joker{
	key = 'theinternet',
	config = { extra = { curchips = 0, bonuschips = 15 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.curchips, card.ability.extra.bonuschips } }
	end,
	unlocked = true,
	rarity = 1,
	atlas = 'TOGAJokersMain',
	pos = { x = 2, y = 3 },
	cost = 3,
	blueprint_compat = true,
	calculate = function(self, card, context)
		card.ability.extra.curchips = (G.GAME.consumeable_usage_total and G.GAME.consumeable_usage_total.all or 0) * card.ability.extra.bonuschips
		
		if context.using_consumeable and not context.blueprint then
			card_eval_status_text(card, 'extra', nil, nil, nil, {message = localize{type = 'variable', key = 'a_chips', vars = { card.ability.extra.curchips } }, colour = G.C.CHIPS })
		end
		
		if context.joker_main and card.ability.extra.curchips > 0 then
			return {
				chips = card.ability.extra.curchips,
			}
		end
	end,
	update = function(self, card, context)
		card.ability.extra.curchips = (G.GAME.consumeable_usage_total and G.GAME.consumeable_usage_total.all or 0) * card.ability.extra.bonuschips
	end
}

SMODS.Joker{
	key = 'computerlock',
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersMain',
	pos = { x = 0, y = 0 },
	cost = 10,
	blueprint_compat = false,
	calculate = function(self, card, context)
		if context.selling_self and not context.retrigger_joker and not context.blueprint_card then
			for i = 1, #G.jokers.cards do
				if G.jokers.cards[i] == card then
					if i > 1 then
						if G.jokers.cards[i-1] and not G.jokers.cards[i-1].ability.eternal and G.jokers.cards[i-1].config.center.key ~= "j_toga_computerlock" then
							G.jokers.cards[i-1]:set_eternal(true)
							G.jokers.cards[i-1].ability.eternal = true
							card_eval_status_text(G.jokers.cards[i-1], 'extra', nil, nil, nil, {message = localize('toga_userlocked'), colour = G.C.RED, sound = not silent and togabalatro.config.SFXWhenTriggered and 'toga_mscmenucmd'})
						elseif G.jokers.cards[i-1] and G.jokers.cards[i-1].ability.eternal then
							G.jokers.cards[i-1]:set_eternal(false)
							G.jokers.cards[i-1].ability.eternal = false
							card_eval_status_text(G.jokers.cards[i-1], 'extra', nil, nil, nil, {message = localize('toga_userunlocked'), colour = G.C.RED, sound = not silent and togabalatro.config.SFXWhenTriggered and 'toga_mscmenucmd'})
						end
					end
					if i < #G.jokers.cards then
						if G.jokers.cards[i+1] and not G.jokers.cards[i+1].ability.eternal and G.jokers.cards[i+1].config.center.key ~= "j_toga_computerlock" then
							G.jokers.cards[i+1]:set_eternal(true)
							G.jokers.cards[i+1].ability.eternal = true
							card_eval_status_text(G.jokers.cards[i+1], 'extra', nil, nil, nil, {message = localize('toga_userlocked'), colour = G.C.RED, sound = not silent and togabalatro.config.SFXWhenTriggered and 'toga_mscmenucmd'})
						elseif G.jokers.cards[i+1] and G.jokers.cards[i+1].ability.eternal then
							G.jokers.cards[i+1]:set_eternal(false)
							G.jokers.cards[i+1].ability.eternal = false
							card_eval_status_text(G.jokers.cards[i+1], 'extra', nil, nil, nil, {message = localize('toga_userunlocked'), colour = G.C.RED, sound = not silent and togabalatro.config.SFXWhenTriggered and 'toga_mscmenucmd'})
						end
					end
				end
			end
		end
	end,
	update = function(self, card, context)
		if card.ability.eternal then card:set_eternal(false); card.ability.eternal = false end
	end
}

-- Random SFX.
local function toga_plus95rndsfx()
	return 'toga_win95pluscmd'..math.random(1, 12)
end

SMODS.Joker{
	key = 'drivespace',
	config = { extra = { reduce = 0.97 }, bypasswu = true },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.reduce } }
	end,
	unlocked = true,
	rarity = 4,
	atlas = 'TOGAJokersMain',
	pos = { x = 2, y = 1 },
	cost = 25,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if card.ability.extra.reduce > 1 then card.ability.extra.reduce = 1 end -- catch.
		
		if context.cardarea == G.play then
			if context.other_card and not context.before and not context.after and not context.repetition and not context.repetition_only then
				-- card_eval_status_text(card, 'extra', nil, nil, nil, {message = 'Compress!', colour = G.C.FILTER})
				G.E_MANAGER:add_event(Event({func = function()
					G.GAME.blind.chips = math.floor(G.GAME.blind.chips*card.ability.extra.reduce)
					G.GAME.blind.chip_text = number_format(G.GAME.blind.chips)
					G.FUNCS.blind_chip_UI_scale(G.hand_text_area.blind_chips)
					G.HUD_blind:recalculate() 
					G.hand_text_area.blind_chips:juice_up()
					card:juice_up()
	
					if not silent and togabalatro.config.SFXWhenTriggered then play_sound(toga_plus95rndsfx()) end
				return true end }))
			end
		end
	end,
	update = function(self, card, context)
		if card.ability.extra.reduce > 1 then card.ability.extra.reduce = 1 end -- catch.
	end
}

SMODS.Joker{
	key = 'systemrestore',
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersMain',
	pos = { x = 0, y = 4 },
	cost = 12,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.remove_playing_cards then
			local addedcards = {}
			for i = 1, #context.removed do
				if togabalatro.config.DoMoreLogging then sendInfoMessage(context.removed[i].base.id, "TOGAPack") end
				local _card = copy_card(context.removed[1], nil, nil, G.playing_card)
				_card:add_to_deck()
				G.deck.config.card_limit = G.deck.config.card_limit + 1
				table.insert(G.playing_cards, _card)
				G.deck:emplace(_card)
				table.insert(addedcards, _card)
			end
			playing_card_joker_effects(addedcards)
			return { message = localize('toga_systemrestore1') }
		end
	end
}

local function toga_randomruntext()
	local stringtable = { localize('toga_jimbo95txt1'), localize('k_again_ex'), localize('toga_jimbo95txt2'), localize('toga_jimbo95txt3'), localize('toga_jimbo95txt4') }
	return stringtable[math.random(#stringtable)]
end

SMODS.Joker{
	key = 'jimbo95',
	config = { extra = { h_size = 2, retriggers = 1, x_chips = 1.5, x_mult = 1.5} },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.h_size, card.ability.extra.retriggers, card.ability.extra.x_chips, card.ability.extra.x_mult } }
	end,
	unlocked = true,
	discovered = true,
	rarity = 4,
	atlas = 'TOGAJokersMain',
	pos = { x = 2, y = 0 },
	soul_pos = { x = 4, y = 0 },
	cost = 25,
	blueprint_compat = true,
	perishable_compat = false,
	add_to_deck = function(self, card, from_debuff)
		G.hand:change_size(card.ability.extra.h_size)
	end,
	remove_from_deck = function(self, card, from_debuff)
		G.hand:change_size(-card.ability.extra.h_size)
	end,
	calculate = function(self, card, context)
		if context.joker_main then
			if card.ability.extra.x_chips < 1 then card.ability.extra.x_chips = 1 end -- no reduce.
			if card.ability.extra.x_mult < 1 then card.ability.extra.x_mult = 1 end -- only extend.

			return {
				x_chips = card.ability.extra.x_chips > 1 and card.ability.extra.x_chips or nil,
				xchip_message = card.ability.extra.x_chips > 1 and {message = localize{ type = "variable", key = "a_xchips", vars = { card.ability.extra.x_chips } }, colour = G.C.CHIPS, sound = "xchips"} or nil,
				x_mult = card.ability.extra.x_mult > 1 and card.ability.extra.x_mult or nil
			}
		end
		if context.retrigger_joker_check and not context.retrigger_joker and context.other_card ~= card and context.other_card.config.center.key ~= 'j_toga_jimbo95' then
			if card.ability.extra.retriggers < 1 then card.ability.extra.retriggers = 1 end -- always at least once.
			return {
				message = toga_randomruntext(),
				repetitions = card.ability.extra.retriggers,
				card = card,
			}
		end
	end,
	update = function(self, card)
		if card.ability.extra.x_chips < 1 then card.ability.extra.x_chips = 1 end -- no reduce.
		if card.ability.extra.x_mult < 1 then card.ability.extra.x_mult = 1 end -- only extend.
		if card.ability.extra.retriggers < 1 then card.ability.extra.retriggers = 1 end -- always at least once.
	end
}

SMODS.Joker{
	key = 'win95',
	config = { extra = { hands = 1, discards = 1, money = 4, Xmoney = 2, slots = 3 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.hands, card.ability.extra.discards, card.ability.extra.money, card.ability.extra.Xmoney, card.ability.extra.slots } }
	end,
	unlocked = true,
	discovered = true,
	rarity = 2,
	atlas = 'TOGAJokersWindows',
	pos = { x = 0, y = 0 },
	cost = 7,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.setting_blind and not (context.blueprint_card or card).getting_sliced then
			ease_hands_played(card.ability.extra.hands)
			ease_discard(card.ability.extra.discards)
			return { message = localize('toga_32bits') }
		end
	end,
	calc_dollar_bonus = function(self, card)
		if card.ability.extra.money > 0 then
			if #G.jokers.cards <= card.ability.extra.slots then
				return card.ability.extra.money * card.ability.extra.Xmoney
			else
				return card.ability.extra.money
			end
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_win95start")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			if not from_debuff then play_sound("toga_win95tada")
			else play_sound("toga_chordold") end
		end
	end
}

local function toga_gettotaljokervalue()
	local value = 0
	if G.jokers then
		for i = 1, #G.jokers.cards do
			if G.jokers.cards[i].ability.set == 'Joker' then
				value = value + G.jokers.cards[i].sell_cost
			end
		end
	end
	return value
end

SMODS.Joker{
	key = 'win98',
	config = { extra = { consslotbonus = 0.1, totalconsslotbonus = 0, percentage = 0.125 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.consslotbonus*100, card.ability.extra.totalconsslotbonus*100, card.ability.extra.percentage*100, toga_gettotaljokervalue()*card.ability.extra.percentage } }
	end,
	unlocked = true,
	rarity = 2,
	atlas = 'TOGAJokersWindows',
	pos = { x = 1, y = 0 },
	cost = 5,
	blueprint_compat = true,
	calculate = function(self, card, context)
		--if context.joker_main then
		if context.individual and context.cardarea == G.play then
			local sellvalues = toga_gettotaljokervalue()*card.ability.extra.percentage
			local slotbonus = sellvalues*#G.consumeables.cards*card.ability.extra.consslotbonus or 0
			return {
				mult = sellvalues + slotbonus
			}
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_win98start")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			if not from_debuff then play_sound("toga_win98tada")
			else play_sound("toga_chord") end
		end
	end,
	update = function(self, card, context)
		card.ability.extra.totalconsslotbonus = G.consumeables and #G.consumeables.cards*card.ability.extra.consslotbonus or 0
	end
}

local function toga_vouchcount()
	local vouchercount = 0
	for i, v in pairs(G.GAME.used_vouchers) do
		if v == true then vouchercount = vouchercount + 1 end
	end
	return vouchercount
end

SMODS.Joker{
	key = 'winmillenium',
	config = { extra = { basechips = 25, chipbonus = 25, totalbonus = 25 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.basechips, card.ability.extra.chipbonus, card.ability.extra.totalbonus } }
	end,
	unlocked = true,
	rarity = 2,
	atlas = 'TOGAJokersWindows',
	pos = { x = 2, y = 0 },
	cost = 6,
	blueprint_compat = true,
	calculate = function(self, card, context)
		card.ability.extra.totalbonus = card.ability.extra.basechips + card.ability.extra.basechips*toga_vouchcount()
		
		if context.other_joker then
			return {
				chips = card.ability.extra.totalbonus
			}
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_winme2000start")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			if not from_debuff then play_sound("toga_winme2000shutdown")
			else play_sound("toga_chord") end
		end
	end,
	update = function(self, card, context)
		card.ability.extra.totalbonus = card.ability.extra.basechips + card.ability.extra.basechips*toga_vouchcount()
	end
}

SMODS.Joker{
	key = 'winnt4',
	config = { extra = { repetitions = 1 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.repetitions } }
	end,
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersWindows',
	pos = { x = 0, y = 1 },
	cost = 10,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.cardarea == G.play and context.repetition and not context.repetition_only then
			if not context.other_card:is_face() then
				-- This is basically the inverse of Sock and Buskin...
				return {
					message = localize('k_again_ex'),
					repetitions = card.ability.extra.repetitions,
					card = card
				}
			end
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_winnt4start")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			if not from_debuff then play_sound("toga_winnt4shutdown")
			else play_sound("toga_chordold") end
		end
	end
}

SMODS.Joker{
	key = 'win2000',
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersWindows',
	pos = { x = 1, y = 1 },
	cost = 10,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.end_of_round and not (context.individual or context.repetition) then
			G.E_MANAGER:add_event(Event({
				func = (function()
					local gettag = get_next_tag_key()
					if gettag == 'tag_orbital' then gettag = 'tag_negative' end
					add_tag(Tag(gettag))
					card:juice_up(0.3, 0.4)
					play_sound('generic1', 0.9 + math.random()*0.1, 0.8)
					play_sound('holo1', 1.2 + math.random()*0.1, 0.4)
					return true
				end)
			}))
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_winme2000start")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			if not from_debuff then play_sound("toga_winme2000shutdown")
			else play_sound("toga_chord") end
		end
	end
}

SMODS.Joker{
	key = 'winxp',
	config = { extra = { repetitions = 1 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.repetitions } }
	end,
	unlocked = true,
	rarity = 4,
	atlas = 'TOGAJokersWindows',
	pos = { x = 2, y = 1 },
	cost = 20,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if card.ability.extra.repetitions < 1 then card.ability.extra.repetitions = 1 end -- always at least once.
		
		if (context.retrigger_joker_check and not context.retrigger_joker and context.other_card ~= card and context.other_card.config.center.key ~= 'j_toga_winxp')
		or ((context.cardarea == G.play or context.cardarea == G.hand) and context.repetition and not context.repetition_only) then
			return {
				message = localize('k_again_ex'),
				repetitions = card.ability.extra.repetitions,
				card = card,
			}
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_winxplogon")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			if not from_debuff then play_sound("toga_winxplogoff")
			else play_sound("toga_winxpcritstop") end
		end
	end
}

SMODS.Joker{
	key = 'clippit',
	config = { extra = { repetitions = 3 } },
	loc_vars = function(self, info_queue, card)
		if self.discovered then
			info_queue[#info_queue + 1] = {key = "toga_clippyorigin", set = 'Other'}
		end
		return { vars = { card.ability.extra.repetitions, card.ability.extra.handsize, card.ability.extra.bosshandsize } }
	end,
	unlocked = true,
	rarity = 4,
	atlas = 'TOGAJokersMain',
	pos = { x = 1, y = 2 },
	soul_pos = { x = 4, y = 2 },
	cost = 25,
	blueprint_compat = true,
	calculate = function(self, card, context)
		local repeats = card.ability.extra.repetitions
		if context.cardarea == G.hand and context.repetition then
			return {
				message = localize('k_again_ex'),
				repetitions = repeats,
				sound = not silent and togabalatro.config.SFXWhenTriggered and "toga_officehammer",
				card = card
			}
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_o97doorbell")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_o97glide")
		end
	end,
}

SMODS.Joker{
	key = 'rover',
	config = { extra = { odds = 8, curstate = "shop" }, bypasswu = true },
	loc_vars = function(self, info_queue, card)
		return { vars = { G.GAME.probabilities.normal or 1, card.ability.extra.odds } }
	end,
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokerRover',
	pos = { x = 0, y = 0 },
	soul_pos = { x = 1, y = 0 },
	cost = 15,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.joker_main then
			for i = 1, #G.deck.cards do
				if pseudorandom("toga_rover") < G.GAME.probabilities.normal/card.ability.extra.odds then
					SMODS.score_card(G.deck.cards[i], {cardarea = G.play, full_hand = context.full_hand, scoring_hand = context.scoring_hand, scoring_name = context.scoring_name, poker_hands = context.poker_hands})
				end
			end
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		card.ability.extra.animated = true
	end,
	remove_from_deck = function(self, card, from_debuff)
		card.ability.extra.animated = nil
	end,
	update = function(self, card)
		if not card.ability.extra.animated then return end
		
		if G.STATE == G.STATES.GAME_OVER then
			card.ability.extra.curstate = "loss"
			card.children.floating_sprite:set_sprite_pos({x = 7, y = 0})
		elseif G.GAME.won and G.OVERLAY_MENU and G.OVERLAY_MENU.config.no_esc then
			card.ability.extra.curstate = "win"
			card.children.floating_sprite:set_sprite_pos({x = 4, y = 0})
		elseif G.shop then
			card.ability.extra.curstate = "shop"
			card.children.floating_sprite:set_sprite_pos({x = 3, y = 0})
		elseif G.round_eval then
			card.ability.extra.curstate = "roundeval"
			card.children.floating_sprite:set_sprite_pos({x = 2, y = 0})
		elseif G.booster_pack then
			card.ability.extra.curstate = "booster"
			card.children.floating_sprite:set_sprite_pos({x = 3, y = 0})
		elseif G.blind_select then
			card.ability.extra.curstate = "blindselect"
			card.children.floating_sprite:set_sprite_pos({x = 5, y = 0})
		elseif G.GAME.blind then
			card.ability.extra.curstate = "inblind"
			if G.GAME.blind.boss then
				card.children.floating_sprite:set_sprite_pos({x = 6, y = 0})
			else
				card.children.floating_sprite:set_sprite_pos({x = 1, y = 0})
			end
		else -- Just so we don't crash.
			card.ability.extra.curstate = "fallback"
			card.children.floating_sprite:set_sprite_pos({x = 1, y = 0})
		end
	end
}

SMODS.Joker{
	key = 'solitairejoker',
	config = { extra = { h_size = 3, chips = 100, hands = 1 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.h_size, card.ability.extra.chips, card.ability.extra.hands } }
	end,
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersOther',
	pos = { x = 0, y = 0 },
	cost = 8,
	blueprint_compat = true,
	add_to_deck = function(self, card, from_debuff)
		G.hand:change_size(card.ability.extra.h_size)
		G.GAME.round_resets.hands = G.GAME.round_resets.hands - card.ability.extra.hands
	end,
	remove_from_deck = function(self, card, from_debuff)
		G.hand:change_size(-card.ability.extra.h_size)
		G.GAME.round_resets.hands = G.GAME.round_resets.hands + card.ability.extra.hands
	end,
	calculate = function(self, card, context)
		if context.joker_main then return { chips = card.ability.extra.chips } end
	end
}

local function toga_checkxmultsafe(card)
	local xmultcheck = card.ability.extra.Xmult_current / card.ability.extra.shortcutfailmult
	if xmultcheck < 1 then return false else return true end
end

SMODS.Joker{
	key = 'jokersrb2kart',
	config = { extra = { Xmult_current = 1, add_shop = 0.04, addshortcut = 0.75, shortcutfailmult = 1.33, maxchance = 3, toexactchance = 1} },
	loc_vars = function(self, info_queue, card)
		if self.discovered then
			info_queue[#info_queue + 1] = {key = "toga_kartjokerlist", set = 'Other', vars = { card.ability.extra.add_shop, card.ability.extra.add_shop*5 } }
			if G.GAME.selected_back.effect.center.key == 'b_toga_srb2kartdeck' then info_queue[#info_queue + 1] = {key = "toga_kartjokershortcutspecial", set = 'Other', vars = { card.ability.extra.addshortcut/2.5 } }
			else
				info_queue[#info_queue + 1] = {key = "toga_kartjokershortcut", set = 'Other', vars =
					{ (G.GAME.probabilities.normal or 1) * card.ability.extra.toexactchance, card.ability.extra.maxchance,
					card.ability.extra.addshortcut, math.abs((1-card.ability.extra.shortcutfailmult)*100) }
				}
			end
		end
		return { vars = { card.ability.extra.Xmult_current } }
	end,
	unlocked = true,
	rarity = 2,
	atlas = 'TOGAJokersOther',
	pos = { x = 1, y = 0 },
	cost = 10,
	blueprint_compat = true,
	perishable_compat = false,
	calculate = function(self, card, context)
		if not card then return end
		if card.ability.extra.eliminated or card.debuff then return end
		
		if card.ability.extra.Xmult_current < 1 and not card.debuff then -- Catch.
			play_sound('tarot1')
			card_eval_status_text(card, 'extra', nil, nil, nil, {message = localize('toga_karteliminated'), colour = G.C.RED, sound = not silent and togabalatro.config.SFXWhenTriggered and 'toga_ssb64crowdohh'})
			card.ability.extra.Xmult_current = 0
			card.ability.extra.eliminated = true
			SMODS.debuff_card(card, true, card)
			return true
		end
		
		if (context.buying_card or context.selling_card or context.playing_card_added or context.ending_shop or context.using_consumeable or context.open_booster or context.reroll_shop or context.ending_shop)
		and not context.individual and not context.blueprint then
			card.ability.extra.Xmult_current = card.ability.extra.Xmult_current + (context.ending_shop and card.ability.extra.add_shop*5 or context.playing_card_added and context.cards and #context.cards and card.ability.extra.add_shop*#context.cards or card.ability.extra.add_shop)
			G.E_MANAGER:add_event(Event({func = function()
				card_eval_status_text(card, 'extra', nil, nil, nil, {message = localize('k_upgrade_ex')});
				return true
			end}))
		elseif (context.skip_blind or context.skipping_booster) and not context.blueprint then
			if pseudorandom('j_toga_jokersrb2kart') > (G.GAME.probabilities.normal * card.ability.extra.toexactchance) / card.ability.extra.maxchance and G.GAME.selected_back.effect.center.key ~= 'b_toga_srb2kartdeck' then
				if not toga_checkxmultsafe(card) then
					-- Eliminated!
					card.ability.extra.Xmult_current = 0
					card.ability.extra.eliminated = true
					SMODS.debuff_card(card, true, card)
					return {message = localize('toga_karteliminated'), colour = G.C.RED, sound = not silent and togabalatro.config.SFXWhenTriggered and 'toga_ssb64crowdohh'}
				else
					card.ability.extra.Xmult_current = card.ability.extra.Xmult_current / card.ability.extra.shortcutfailmult
					return {message = localize('toga_kartouch'), colour = G.C.RED}
				end
			else
				local shortcutbonus = G.GAME.selected_back.effect.center.key == 'b_toga_srb2kartdeck' and card.ability.extra.addshortcut/2.5 or card.ability.extra.addshortcut
				card.ability.extra.Xmult_current = card.ability.extra.Xmult_current + shortcutbonus
				return {message = localize('k_upgrade_ex')}
			end
		elseif context.joker_main then
			if card.ability.extra.Xmult_current > 1 then return { x_mult = card.ability.extra.Xmult_current } end
		end
	end,
}

SMODS.Joker{
	key = 'asterism',
	config = { extra = { curmult = 0, bonusmult = 5 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.curmult > 0 and card.ability.extra.curmult or (G.GAME.consumeable_usage_total and G.GAME.consumeable_usage_total.planet or 0) * card.ability.extra.bonusmult, card.ability.extra.bonusmult } }
	end,
	unlocked = true,
	rarity = 2,
	atlas = 'TOGAJokersOther',
	pos = { x = 0, y = 1 },
	cost = 6,
	blueprint_compat = true,
	calculate = function(self, card, context)
		card.ability.extra.curmult = (G.GAME.consumeable_usage_total and G.GAME.consumeable_usage_total.planet or 0) * card.ability.extra.bonusmult
		
		if context.using_consumeable and not context.blueprint and context.consumeable.ability.set == 'Planet' then
			card_eval_status_text(card, 'extra', nil, nil, nil, {message = localize{type = 'variable', key = 'a_mult', vars = { card.ability.extra.curmult } } })
		end
		
		if context.joker_main and card.ability.extra.curmult > 0 then return { mult = card.ability.extra.curmult } end
	end
}

SMODS.Joker{
	key = 'bonusducks',
	unlocked = true,
	loc_vars = function(self, info_queue, card)
		info_queue[#info_queue + 1] = G.P_CENTERS.m_bonushat
	end,
	rarity = 2,
	atlas = 'TOGAJokersOther',
	pos = { x = 1, y = 1 },
	cost = 7,
	blueprint_compat = false,
	calculate = function(self, card, context)
		if context.blueprint then return end
		
		if context.cardarea == G.jokers and context.before then
			local faces = {}
			for k, v in ipairs(context.scoring_hand) do
				if v:is_face() then 
					faces[#faces+1] = v
					v:set_ability(G.P_CENTERS.m_bonus, nil, true)
					G.E_MANAGER:add_event(Event({
						func = function()
							v:juice_up()
							return true
						end
					})) 
				end
			end
			if #faces > 0 then
				return {
					message = localize('toga_bonusapply'),
					colour = G.C.CHIPS,
					card = card,
					sound = not silent and togabalatro.config.SFXWhenTriggered and 'toga_duck',
					pitch = not silent and togabalatro.config.SFXWhenTriggered and toga_randompitch()
				}
			end
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_duck")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_kcud")
		end
	end,
}

-- Count steel card amount in full deck and round down the returned result.
local _counting_steel = false
local function toga_gettotalsteelcount()
	-- If we're already counting steel, return 0 to break the recursion
	if _counting_steel then return 0 end
	
	_counting_steel = true
	local allsteel = 0
	if G.playing_cards then
		for k, v in pairs(G.playing_cards) do
			if SMODS.has_enhancement(v, "m_steel") then allsteel = allsteel+1 end
		end
	end
	_counting_steel = false
	return math.floor(allsteel/4)
end

-- Update variable for Anvil.
local function toga_updatesteelrepeat(target)
	return toga_gettotalsteelcount()*target.ability.extra.repetitions
end

SMODS.Joker{
	key = 'mcanvil',
	config = { extra = { repetitions = 1, totalrepetitions = 0 } },
	loc_vars = function(self, info_queue, card)
		info_queue[#info_queue + 1] = G.P_CENTERS.m_steel
		return { vars = { math.floor(card.ability.extra.repetitions), toga_updatesteelrepeat(card) } }
	end,
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersOther',
	pos = { x = 2, y = 1 },
	soul_pos = { x = 4, y = 1 },
	cost = 10,
	blueprint_compat = true,
	calculate = function(self, card, context)
		card.ability.extra.totalrepetitions = card.ability.extra.repetitions*toga_gettotalsteelcount() or 0
		if context.cardarea == G.play and context.repetition and not context.repetition_only and card.ability.extra.totalrepetitions >= 1 then
			return {
				message = localize('toga_anviltrigger'),
				repetitions = math.floor(card.ability.extra.totalrepetitions),
				card = card,
				sound = not silent and togabalatro.config.SFXWhenTriggered and 'toga_anviluse',
				pitch = not silent and togabalatro.config.SFXWhenTriggered and toga_randompitch()
			}
		end
	end,
	update = function(self, card)
		card.ability.extra.totalrepetitions = card.ability.extra.repetitions*toga_gettotalsteelcount() or 0
	end
}

-- Get repeats, up to 65536. Will use Talisman functions if present.
local function toga_cashpointmulitple(cashpoint)
	local getmultiples = to_big(G.GAME.dollars)/to_big(cashpoint)
	if Talisman then getmultiples = getmultiples:to_number() end
	return math.min(math.floor(getmultiples), 65535) + 1
end

SMODS.Joker{
	key = 'spacecadetpinball',
	config = { extra = { cashpoint = 20, alltrig = 1 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.cashpoint, card.ability.extra.alltrig-1, (G.GAME and G.GAME.probabilities.normal or 1) } }
	end,
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersOther',
	pos = { x = 0, y = 2 },
	cost = 15,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.joker_main then
			card.ability.extra.alltrig = toga_cashpointmulitple(card.ability.extra.cashpoint) or 1
			for i = 1, card.ability.extra.alltrig do
				if pseudorandom("toga_spacecadetpinball") < G.GAME.probabilities.normal/3 then -- hard cap.
					SMODS.score_card(pseudorandom_element(context.scoring_hand, pseudoseed('spacecadet')), {cardarea = G.play, full_hand = context.full_hand, scoring_hand = context.scoring_hand, scoring_name = context.scoring_name, poker_hands = context.poker_hands})
				end
			end
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_pinballstart")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_pinballloseball")
		end
	end,
	update = function(self, card, context)
		card.ability.extra.alltrig = toga_cashpointmulitple(card.ability.extra.cashpoint) + 1 or 1
	end
}

SMODS.Joker{
	key = 'heartyspades',
	unlocked = true,
	rarity = 2,
	atlas = 'TOGAJokersOther',
	pos = { x = 0, y = 4 },
	cost = 6,
	blueprint_compat = false,
	pixel_size = { w = 69, h = 74 }
}

SMODS.Joker{
	key = 'binaryjkr',
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersOther',
	pos = { x = 0, y = 3 },
	cost = 8,
	blueprint_compat = false
}

SMODS.Joker{
	key = 'hexadecimaljkr',
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersOther',
	pos = { x = 1, y = 3 },
	cost = 8,
	blueprint_compat = false
}

SMODS.Joker{
	key = 'y2ksticker',
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersOther',
	pos = { x = 2, y = 4 },
	cost = 7,
	blueprint_compat = false,
	pixel_size = { w = 69, h = 38 }
}

SMODS.Joker{
	key = 'pso2ironwill',
	config = { extra = { skillactive = true, skillactivetext = localize('toga_pso2ironwillready') or "Ready!" } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.skillactive, card.ability.extra.skillactivetext } }
	end,
	unlocked = true,
	rarity = 4,
	in_pool = function()
		if #SMODS.find_card('j_toga_pso2ironwill', true) > 0 then return false
		else return true end
	end,
	atlas = 'TOGAJokersOther',
	pos = { x = 4, y = 2 },
	cost = 30,
	blueprint_compat = false,
	calculate = function(self, card, context)
		if card.ability.extra.skillactive and context.end_of_round and context.game_over and not context.repetition and not context.individual and to_big(G.GAME.dollars) > to_big(0) then
			card.ability.extra.skillactive = false
			card.ability.extra.skillactivetext = localize('toga_pso2ironwillrecharge')
			G.GAME.current_round.usesavedtext = true
			G.GAME.current_round.savedtext = localize('toga_pso2ironwillsave')
			ease_dollars(to_big(-G.GAME.dollars), true)
			return {
				message = localize('toga_pso2ironwillproc'),
				saved = true,
				colour = G.C.RED
			}
		end
		
		if context.end_of_round and not (context.individual or context.repetition or context.blueprint) and G.GAME.blind.boss and not card.ability.extra.skillactive then
			card.ability.extra.skillactive = true
			card_eval_status_text(card, 'extra', nil, nil, nil, {message = localize('toga_pso2ironwillready')})
		end
	end,
	update = function(self, card)
		if card.ability.extra.skillactive == true then card.ability.extra.skillactivetext = localize('toga_pso2ironwillready')
		else card.ability.extra.skillactivetext = localize('toga_pso2ironwillrecharge') end
	end
}

local function toga_jimbopluscalc(card)
	local totalxmult = 1
	
	if G.jokers and G.jokers.cards then
		for i = 1, #G.jokers.cards do
			if G.jokers.cards[i] and G.jokers.cards[i] ~= card then
				if G.jokers.cards[i].config.center.key == 'j_joker' then totalxmult = totalxmult + card.ability.extra.jimboxmult
				elseif G.jokers.cards[i].config.center.key ~= 'j_toga_jimboplus' then totalxmult = totalxmult + card.ability.extra.otherxmult end
			end
		end
	end
	
	return math.max(totalxmult, 1)
end

SMODS.Joker{
	key = 'jimboplus',
	config = { extra = { jimboxmult = 0.5, otherxmult = 0.05 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.jimboxmult, card.ability.extra.otherxmult, toga_jimbopluscalc(card) } }
	end,
	unlocked = true,
	rarity = 3,
	atlas = 'TOGAJokersOther',
	pos = { x = 1, y = 2 },
	cost = 8,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.individual and context.cardarea == G.play then
			local xval = toga_jimbopluscalc(card) or 1
			return { xmult = xval > 1 and xval, message_card = card }
		end
		
		if context.end_of_round and not (context.individual or context.repetition or context.blueprint) and togabalatro.config.SFXWhenTriggered and not silent then
			return { message = localize('toga_jimbo'), sound = "voice"..math.random(1, 11), pitch = toga_randompitch() }
		end
	end
}

local function toga_gethowmuch(div, inputxmult)
	-- Whatever Bootstraps was doing with Talisman... this works well enough instead.
	local dol, dolbuffer = G.GAME.dollars, G.GAME.dollar_buffer and G.GAME.dollar_buffer > 0 and G.GAME.dollar_buffer or 0
	local amount, count = to_big(dol) + to_big(dolbuffer), 0
	while to_big(amount) - to_big(div) > to_big(0) do
		count = count + 1
		amount = to_big(amount) - to_big(div)
	end
	return count and count > 0 and 1 + (inputxmult * count) or 1
end

SMODS.Joker{
	key = 'speedsneakers',
	config = { extra = { xmultpart = 0.1, dollars = 5 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.xmultpart, card.ability.extra.dollars, toga_gethowmuch(card.ability.extra.dollars, card.ability.extra.xmultpart) } }
	end,
	unlocked = true,
	rarity = 2,
	atlas = 'TOGAJokersOther',
	pos = { x = 1, y = 4 },
	cost = 5,
	blueprint_compat = true,
	pixel_size = { w = 69, h = 74 },
	calculate = function(self, card, context)
		if context.joker_main then
			return { xmult = toga_gethowmuch(card.ability.extra.dollars, card.ability.extra.xmultpart) }
		end
	end
}

local function toga_subtable(ttable, found, increase, depthiter)
	depthiter = depthiter or 1
	if depthiter > 32 then return end -- Just in case.
	for k, v in pairs(ttable) do
		if type(v) == 'number' then
			local rplc = v*(1+increase)
			ttable[k] = rplc
			foundmodified = true
		elseif type(v) == 'table' then
			toga_subtable(v, found, increase, depthiter) -- This is a bit dangerous...
		end
	end
end

-- Most Jokers (should) use card.ability.extra anyway...
local function toga_rndvaluetarget(origcard, increase, curiter)
	curiter = curiter or 1
	if togabalatro.config.DoMoreLogging then sendInfoMessage("Joker Update - "..curiter.." out of 32", "TOGAPack") end
	
	-- Find random joker that is not one of ourselves.
	--local selectedjoker = G.jokers.cards[math.random(1, #G.jokers.cards)]
	local selectedjoker = pseudorandom_element(G.jokers.cards, pseudoseed('j_toga_update'))
	if #G.jokers.cards > 1 then
		while selectedjoker.config.center.key == 'j_toga_winupdate' or selectedjoker.ability.bypasswu or selectedjoker.ability.immutable do
			selectedjoker = pseudorandom_element(G.jokers.cards, pseudoseed('j_toga_update'))
		end
		if togabalatro.config.DoMoreLogging then sendInfoMessage("Joker Update - "..tostring(selectedjoker.config.center.key), "TOGAPack") end
	else selectedjoker = nil; return false end
	
	local foundmodified = false
	if type(selectedjoker.ability.extra) == 'number' then
		local rplc = selectedjoker.ability.extra+(selectedjoker.ability.extra*increase)
		selectedjoker.ability.extra = rplc
		foundmodified = true
	elseif type(selectedjoker.ability.extra) == 'table' then
		for k, v in pairs(selectedjoker.ability.extra) do
			if type(v) == 'number' then
				local rplc = v*(1+increase)
				selectedjoker.ability.extra[k] = rplc
				foundmodified = true
			elseif type(v) == 'table' then
				toga_subtable(v, foundmodified, increase) -- This is a bit dangerous...
			end
		end
	end
	if foundmodified then
		origcard.ability.extra.active = localize('toga_inactive')
		origcard.ability.extra.canupgrade = false
		origcard:juice_up()
		card_eval_status_text(selectedjoker, 'extra', nil, nil, nil, {message = localize('toga_updated')})
		if togabalatro.config.DoMoreLogging then sendInfoMessage("Joker Update - "..tostring(selectedjoker.config.center.key).." successfully altered.", "TOGAPack") end
		return true
	else
		if curiter < 32 then -- try again
			curiter = curiter + 1
			toga_rndvaluetarget(origcard, increase, curiter)
		else
			if togabalatro.config.DoMoreLogging then sendInfoMessage("Joker Update - Exceeded search attempts or could not find eligible Joker, aborting...", "TOGAPack") end
			return false
		end
	end
end
local winupdateframes = {0, 1, 2, 3, 4, 5, 5, 4, 3, 2, 1}

SMODS.Joker{
	key = 'winupdate',
	config = { extra = { plusval = 0.25 }, },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.plusval*100, card.ability.extra.active } }
	end,
	unlocked = true,
	rarity = 4,
	atlas = 'TOGAJokersUpdate',
	pos = { x = 0, y = 0 },
	cost = 25,
	blueprint_compat = true,
	perishable_compat = false,
	calculate = function(self, card, context)
		if context.end_of_round and not context.repetition and not context.individual and G.GAME.blind.boss then
			toga_rndvaluetarget(card, card.ability.extra.plusval)
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		card.ability.extra.animated = true
	end,
	remove_from_deck = function(self, card, from_debuff)
		card.ability.extra.animated = nil
	end,
	update = function(self, card, context)
		if not card.ability.extra.animated then return end
		if G.jokers and G.jokers.config and G.jokers.config.card_limit < 0 then G.jokers.config.card_limit = 1 end -- Just in case.
		local timer = (G.TIMERS.REAL * 4) 
		local frame_amount = #winupdateframes
		local wrapped_value = (math.floor(timer) - 1) % frame_amount + 1
		card.children.center:set_sprite_pos({x = winupdateframes[wrapped_value], y = 0})
	end,
}

local function toga_calccopiesofself(jkey)
	local count = #SMODS.find_card(jkey)
	return count or 0
end

-- I am currently in a video game where I give XMult for every copy of me held.
SMODS.Joker{
	key = 'tomscott',
	config = { extra = { basexmult = 2 } },
	loc_vars = function(self, info_queue, card)
		return { vars = { card.ability.extra.basexmult, card.ability.extra.basexmult ^ toga_calccopiesofself(card.config.center.key) } }
	end,
	unlocked = true,
	in_pool = function()
		return togabalatro.config.JokeJokersActive -- Should only spawn if allowed to via config!
	end,
	rarity = 2,
	atlas = 'TOGAJokersOther',
	pos = { x = 2, y = 2 },
	cost = 5,
	blueprint_compat = true,
	calculate = function(self, card, context)
		local curxmult = card.ability.extra.basexmult ^ toga_calccopiesofself(card.config.center.key)
		if context.joker_main then
			return { xmult = curxmult }
		end
	end,
	set_badges = function(self, card, badges)
		badges[#badges+1] = create_badge("Joke (TOGA)", G.C.SECONDARY_SET.Tarot, G.C.WHITE, 1 )
	end
}

-- The plumtastic man himself. Joke Joker.
SMODS.Joker{
	key = 'michaelrosen',
	config = { extra = { heldmoney = 10, heldxchip = 1.75, heldxmult = 2, heldechip = 1.3, heldeechip = 1.1, heldeeechip = 1.05, heldemult = 1.2, heldeemult = 1.08, heldeeemult = 1.04, odds = 25 } },
	loc_vars = function(self, info_queue, card)
		if not card.debuff then
			info_queue[#info_queue + 1] = {key = "toga_roseneffects", set = 'Other', vars = { card.ability.extra.heldmoney, card.ability.extra.heldxchip, card.ability.extra.heldxmult }}
			if Talisman then
				info_queue[#info_queue + 1] = {key = "toga_rosentalismanextra", set = 'Other', vars = {
					card.ability.extra.heldechip, card.ability.extra.heldeechip, card.ability.extra.heldeeechip, card.ability.extra.heldemult, card.ability.extra.heldeemult, card.ability.extra.heldeeemult
				}}
			end
		end
		return { vars = { (G.GAME and G.GAME.probabilities.normal or 1), card.ability.extra.odds } }
	end,
	unlocked = true,
	in_pool = function()
		return togabalatro.config.JokeJokersActive -- Should only spawn if allowed to via config!
	end,
	rarity = 4,
	atlas = 'TOGAJokersOther',
	pos = { x = 2, y = 3 },
	soul_pos = { x = 4, y = 3 },
	cost = 33,
	blueprint_compat = true,
	calculate = function(self, card, context)
		if context.cardarea == G.hand and context.other_card and not context.repetition and not context.repetition_only and not context.end_of_round then
			-- Dear god.
			return {
				dollars = pseudorandom("michaelrosen_money") < G.GAME.probabilities.normal/card.ability.extra.odds and card.ability.extra.heldmoney or nil,
				x_chips = pseudorandom("michaelrosen_xchips") < G.GAME.probabilities.normal/card.ability.extra.odds and card.ability.extra.heldxchip or nil,
				xchip_message = {message = localize{ type = "variable", key = "a_xchips", vars = { card.ability.extra.heldxchip } }, colour = G.C.CHIPS, sound = "xchips"} or nil,
				x_mult = pseudorandom("michaelrosen_xmult") < G.GAME.probabilities.normal/card.ability.extra.odds and card.ability.extra.heldxmult or nil,
				e_chips = Talisman and pseudorandom("michaelrosen_echips") < G.GAME.probabilities.normal/(card.ability.extra.odds*10) and card.ability.extra.heldechip or nil,
				echip_message = Talisman and {message = localize{ type = "variable", key = "toga_Echip", vars = { card.ability.extra.heldechip } }, colour = G.C.DARK_EDITION, sound = "talisman_echip"} or nil,
				ee_chips = Talisman and pseudorandom("michaelrosen_eechips") < G.GAME.probabilities.normal/(card.ability.extra.odds*20) and card.ability.extra.heldeechip or nil,
				eechip_message = Talisman and {message = localize{ type = "variable", key = "toga_EEchip", vars = { card.ability.extra.heldeechip } }, colour = G.C.DARK_EDITION, sound = "talisman_eechip"} or nil,
				eee_chips = Talisman and pseudorandom("michaelrosen_eeechips") < G.GAME.probabilities.normal/(card.ability.extra.odds*40) and card.ability.extra.heldeeechip or nil,
				eeechip_message = Talisman and {message = localize{ type = "variable", key = "toga_EEEchip", vars = { card.ability.extra.heldeeechip } }, colour = G.C.DARK_EDITION, sound = "talisman_eeechip"} or nil,
				e_mult = Talisman and pseudorandom("michaelrosen_emult") < G.GAME.probabilities.normal/(card.ability.extra.odds*10) and card.ability.extra.heldemult or nil,
				emult_message = Talisman and {message = localize{ type = "variable", key = "toga_Emult", vars = { card.ability.extra.heldemult } }, colour = G.C.DARK_EDITION, sound = "talisman_echip"} or nil,
				ee_mult = Talisman and pseudorandom("michaelrosen_eemult") < G.GAME.probabilities.normal/(card.ability.extra.odds*20) and card.ability.extra.heldeemult or nil,
				eemult_message = Talisman and {message = localize{ type = "variable", key = "toga_EEmult", vars = { card.ability.extra.heldeemult } }, colour = G.C.DARK_EDITION, sound = "talisman_eemult"} or nil,
				eee_mult = Talisman and pseudorandom("michaelrosen_eeemult") < G.GAME.probabilities.normal/(card.ability.extra.odds*40) and card.ability.extra.heldeeemult or nil,
				eeemult_message = Talisman and {message = localize{ type = "variable", key = "toga_EEEmult", vars = { card.ability.extra.heldeeemult } }, colour = G.C.DARK_EDITION, sound = "talisman_eeemult"} or nil,
			}
		end
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound("toga_rosenhello")
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound(from_debuff and "toga_rosenah" or "toga_rosenbye")
		end
	end,
	set_badges = function(self, card, badges)
		badges[#badges+1] = create_badge("Joke (TOGA)", G.C.SECONDARY_SET.Tarot, G.C.WHITE, 1 )
	end
}

-- Joke Joker. Originally had 'whatthefuck' as key.
if Talisman then
	SMODS.Joker{
		key = 'whatisthis',
		config = { extra = { part = 1.05 } },
		loc_vars = function(self, info_queue, card)
			return { vars = { card.ability.extra.part } }
		end,
		unlocked = true,
		in_pool = function()
			return togabalatro.config.JokeJokersActive -- Should only spawn if allowed to via config!
		end,
		rarity = 4,
		atlas = 'TOGAJokersMain',
		pos = { x = 0, y = 2 },
		soul_pos = { x = 4, y = 1 },
		cost = 40,
		blueprint_compat = true,
		calculate = function(self, card, context)
			if context.other_consumeable then
				return {
					ee_mult = card.ability.extra.part > 1 and card.ability.extra.part or nil,
					eemult_message = card.ability.extra.part > 1 and {message = localize{ type = "variable", key = "toga_EEmult", vars = { card.ability.extra.part } }, colour = G.C.DARK_EDITION, sound = "talisman_eemult"} or nil,
				}
			end
		end,
		add_to_deck = function(self, card, from_debuff)
			if G.STAGE == G.STAGES.RUN and not G.screenwipe then card.sell_cost = 0 end
			if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
				play_sound("toga_ie31")
			end
		end,
		remove_from_deck = function(self, card, from_debuff)
			if G.STAGE == G.STAGES.RUN and not G.screenwipe then card.sell_cost = 0 end
			if not from_debuff and togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
				play_sound("toga_access97")
			end
		end,
		set_badges = function(self, card, badges)
			badges[#badges+1] = create_badge("Joke (TOGA)", G.C.SECONDARY_SET.Tarot, G.C.WHITE, 1 )
		end
	}
end

-- Joke Joker. Bit of an inside funny.
if Talisman then
	SMODS.Joker{
		key = 'quacksoft',
		config = { extra = { baseechip = 1, cardechip = 0.01 } },
		loc_vars = function(self, info_queue, card)
			return { vars = { card.ability.extra.cardechip, G.deck and G.deck.cards and card.ability.extra.baseechip + (card.ability.extra.cardechip*#G.deck.cards) or card.ability.extra.baseechip } }
		end,
		unlocked = true,
		in_pool = function()
			return togabalatro.config.JokeJokersActive -- Should only spawn if allowed to via config!
		end,
		rarity = 4,
		atlas = 'TOGAJokersOther',
		pos = { x = 2, y = 0 },
		soul_pos = { x = 4, y = 0 },
		cost = 32,
		blueprint_compat = true,
		calculate = function(self, card, context)
			if context.joker_main then
				local echipcalc = (card.ability.extra.baseechip + (card.ability.extra.cardechip*#G.deck.cards))
				return {
					-- Echip_mod = card.ability.extra.part,
					-- message = localize({ type = "variable", key = "toga_Echip", vars = { card.ability.extra.part } }),
					-- colour = G.C.DARK_EDITION
					
					e_chips = echipcalc > 1 and echipcalc or nil,
					echip_message = echipcalc > 1 and {message = localize{ type = "variable", key = "toga_Echip", vars = { echipcalc } }, colour = G.C.DARK_EDITION, sound = "talisman_echip"} or nil
				}
			end
		end,
		add_to_deck = function(self, card, from_debuff)
			if G.STAGE == G.STAGES.RUN and not G.screenwipe then card.sell_cost = 0 end
			if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
				play_sound("toga_duck")
			end
		end,
		remove_from_deck = function(self, card, from_debuff)
			if G.STAGE == G.STAGES.RUN and not G.screenwipe then card.sell_cost = 0 end
			if not from_debuff and togabalatro.config.SFXWhenRemoving and G.STAGE == G.STAGES.RUN and not G.screenwipe then
				play_sound("toga_kcud")
			end
		end,
		set_badges = function(self, card, badges)
			badges[#badges+1] = create_badge("Joke (TOGA)", G.C.SECONDARY_SET.Tarot, G.C.WHITE, 1 )
		end,
		update = function(self, card, context)
			if card.ability.extra.baseechip < 1 then card.ability.extra.baseechip = 1 end
		end
	}
end

local function toga_spbdeckwreck(card, failedchance)
	if not (G.deck and G.deck.cards and #G.deck.cards > 0) then return end
	if failedchance then card_eval_status_text(G.deck.cards[1], 'extra', nil, nil, nil, {message = localize('toga_spbavoidfail'), colour = G.C.RED}) end
	local temp_hand, destroyed_cards = {}, {}
	for k, v in ipairs(G.deck.cards) do temp_hand[#temp_hand+1] = v end
	table.sort(temp_hand, function (a, b) return not a.playing_card or not b.playing_card or a.playing_card < b.playing_card end)
	pseudoshuffle(temp_hand, pseudoseed('spb'))
	
	for i = 1, math.floor(card.ability.extra.cardlimit) do destroyed_cards[#destroyed_cards+1] = temp_hand[i] end
	
	G.E_MANAGER:add_event(Event({trigger = 'after', delay = 0.4, func = function()
		play_sound('tarot1')
		card:juice_up(0.3, 0.5)
	return true end }))
	
	SMODS.calculate_context({remove_playing_cards = true, removed = destroyed_cards})
	
	G.E_MANAGER:add_event(Event({
		trigger = 'after',
		delay = 0.1,
		func = function() 
			for i=#destroyed_cards, 1, -1 do
				local card = destroyed_cards[i]
				if card.ability.name == 'Glass Card' then 
					card:shatter()
				else
					card:start_dissolve(nil, i == #destroyed_cards)
				end
			end
			return true
		end
	}))
end

SMODS.Consumable{
	key = 'selfpropelledbomb',
	set = 'Spectral',
	atlas = "TOGAConsumables",
	pos = {x = 0, y = 0},
	cost = 10,
	config = {extra = { cardlimit = 20, odds = 4, activated = false } },
	loc_vars = function(self, info_queue, card)
		return {vars = { math.floor(card.ability.extra.cardlimit), card.ability.extra.odds, (G.GAME and G.GAME.probabilities.normal or 1) } }
	end,
	can_use = function(self, card, area, copier)
		return G.deck and G.deck.cards and #G.deck.cards > 0
	end,
	use = function(self, card)
		card.ability.extra.activated = true
		toga_spbdeckwreck(card)
		delay(0.5)
	end,
	add_to_deck = function(self, card, from_debuff)
		if not from_debuff and togabalatro.config.SFXWhenAdding and G.STAGE == G.STAGES.RUN and not G.screenwipe then
			play_sound('toga_spb')
		end
	end,
	remove_from_deck = function(self, card, from_debuff)
		if pseudorandom("toga_selfpropelledbomb") < G.GAME.probabilities.normal/card.ability.extra.odds and not card.ability.extra.activated then
			toga_spbdeckwreck(card, true)
		else
			card_eval_status_text(card, 'extra', nil, nil, nil, {message = localize('k_safe_ex'), sound = togabalatro.config.SFXWhenRemoving and 'toga_thundershield'})
		end
	end,
}

SMODS.Consumable {
	key = 'sealingaround',
	set = 'Spectral',
	atlas = "TOGAConsumables",
	pos = {x = 1, y = 0},
	cost = 5,
	config = { max_highlighted = 1, extra = 'toga_sealseal' },
	loc_vars = function(self, info_queue, card)
		info_queue[#info_queue+1] = G.P_SEALS[(card.ability or self.config).extra]
		return {vars = {(card.ability or self.config).max_highlighted}}
	end,
	use = function(self, card, area, copier)
		for i = 1, math.min(#G.hand.highlighted, card.ability.max_highlighted) do
			G.E_MANAGER:add_event(Event({func = function()
				play_sound('tarot1')
				card:juice_up(0.3, 0.5)
				return true end }))
			
			G.E_MANAGER:add_event(Event({trigger = 'after',delay = 0.1,func = function()
				G.hand.highlighted[i]:set_seal(card.ability.extra, nil, true)
				return true end }))
			
			delay(0.5)
		end
		G.E_MANAGER:add_event(Event({trigger = 'after', delay = 0.2,func = function() G.hand:unhighlight_all(); return true end }))
	end
}

SMODS.Consumable {
	key = 'filesource',
	set = 'Spectral',
	atlas = "TOGAConsumables",
	pos = {x = 2, y = 0},
	cost = 5,
	config = { extra = { cards = 1 } },
	loc_vars = function(self, info_queue, card)
		if not togabalatro.config.Experimentals then info_queue[#info_queue+1] = {key = "toga_experimentalstuffdisabled", set = 'Other'}
		else info_queue[#info_queue + 1] = G.P_CENTERS.m_toga_notification end
		return { vars = { card.ability.extra.cards } }
	end,
	in_pool = function()
		return togabalatro.config.Experimentals -- only appear if Experimental objects are enabled
	end,
	can_use = function(self, card)
		if G and G.hand and #G.hand.highlighted ~= 0 and #G.hand.highlighted <= card.ability.extra.cards and togabalatro.config.Experimentals then 
			return true
		end
		return false
	end,
	use = function(self, card, area, copier)
		if not togabalatro.config.Experimentals then return end
		
		G.E_MANAGER:add_event(Event({trigger = 'after', delay = 0.4, func = function()
            play_sound('tarot1')
            card:juice_up(0.3, 0.5)
		return true end }))
		delay(0.2)
		for i, v in pairs(G.hand.highlighted) do
			local percent = 0.85 + (i-0.999)/(#G.hand.highlighted-0.998)*0.3
			G.E_MANAGER:add_event(Event({trigger = 'after',delay = 0.15,func = function() v:flip();play_sound('card1', percent, 1);v:juice_up(0.3, 0.3);return true end }))
			G.E_MANAGER:add_event(Event({trigger = 'after',func = function() v:set_ability(G.P_CENTERS["m_toga_notification"]);return true end }))
			G.E_MANAGER:add_event(Event({trigger = 'after',delay = 0.15,func = function() v:flip();play_sound('tarot2', percent, 0.6);play_sound('toga_winxpballoon', 1, 2.5);v:juice_up(0.3, 0.3);return true end }))
		end
		delay(0.5)
	end,
	set_badges = function(self, card, badges)
        badges[#badges+1] = create_badge(localize('toga_experimental'), G.C.RED, G.C.WHITE, 0.8)
    end,
}

local toga_bgcolorfunc = {
	{ new_colour = HEX("0A246A"), special_colour = HEX("A6CAF0"), contrast = 1.25 },
	{ new_colour = HEX("000080"), special_colour = HEX("1084D0"), contrast = 1.25 },
	{ new_colour = HEX("0054E3"), special_colour = HEX("3D95FF"), contrast = 1.25 }
}

SMODS.Booster{
	name = "ZIP Package",
	key = "togazipboosterpack",
	atlas = 'TOGABoosterPack',
	pos = {x = 0, y = 0},
	weight = 0.6,
	cost = 10,
	group_key = 'togazipboosterpack',
	config = {extra = 3, choose = 1, name = "ZIP Package"},
	discovered = false,
	loc_vars = function(self, info_queue, card)
		return { vars = {card.config.center.config.choose, card.ability.extra} }
	end,
	ease_background_colour = function(self)
		ease_background_colour(toga_bgcolorfunc[math.random(1, #toga_bgcolorfunc)])
	end,
	create_card = function(self, card)
		return create_card('TOGAJKR', G.pack_cards, nil, nil, nil, nil, nil, 'toga')
	end,
}

SMODS.Booster{
	name = "Joker.ZIP",
	key = "togaziparchivepack",
	atlas = 'TOGABoosterPack',
	pos = {x = 1, y = 0},
	weight = 0.8,
	cost = 25,
	group_key = 'togaziparchivepack',
	config = {extra = 10, choose = 2, name = "Joker.ZIP"},
	discovered = false,
	loc_vars = function(self, info_queue, card)
		return { vars = {card.config.center.config.choose, card.ability.extra} }
	end,
	ease_background_colour = function(self)
		ease_background_colour({ new_colour = HEX("515966"), special_colour = HEX("121417"), contrast = 1.25 }) -- Longhorn, anyone?
	end,
	create_card = function(self, card)
		return create_card("Joker", G.pack_cards, nil, nil, true, true, nil, 'toga')
	end,
}

SMODS.Tag{
	key = "togajokershop",
	atlas = "TOGATags",
	pos = { x = 0, y = 0 },
	config = { type = "store_joker_create" },
	in_pool = function(self, args)
		return true
	end,
	apply = function(self, tag, context)
		if context.type == "store_joker_create" then
			local card = create_card("TOGAJKR", context.area, nil, nil, nil, nil, nil, "togajokertag")
			create_shop_card_ui(card, "Joker", context.area)
			card.states.visible = false
			tag:yep("+", G.C.RED, function()
				card:start_materialize()
				card.ability.couponed = true
				card:set_cost()
				return true
			end)
			tag.triggered = true
			return card
		end
	end,
}

SMODS.Tag{
	key = "togajokerbooster",
	atlas = "TOGATags",
	pos = { x = 1, y = 0 },
	config = { type = "new_blind_choice" },
	in_pool = function(self, args)
		return true
	end,
	apply = function(self, tag, context)
		local lock = tag.ID
		if context.type == "new_blind_choice" then
			G.CONTROLLER.locks[lock] = true
			tag:yep('+', G.C.ORANGE,function() 
				local key = 'p_toga_togazipboosterpack'
				local card = Card(G.play.T.x + G.play.T.w/2 - G.CARD_W*1.27/2,
				G.play.T.y + G.play.T.h/2-G.CARD_H*1.27/2, G.CARD_W*1.27, G.CARD_H*1.27, G.P_CARDS.empty, G.P_CENTERS[key], {bypass_discovery_center = true, bypass_discovery_ui = true})
				card.cost = 0
				card.from_tag = true
				G.FUNCS.use_card({config = {ref_table = card}})
				card:start_materialize()
				G.CONTROLLER.locks[lock] = nil
				return true
			end)
			tag.triggered = true
			return true
		end
	end,
}

SMODS.Tag{
	key = "togajokerziparchive",
	atlas = "TOGATags",
	pos = { x = 6, y = 0 },
	config = { type = "new_blind_choice" },
	in_pool = function(self, args)
		return true
	end,
	apply = function(self, tag, context)
		local lock = tag.ID
		if context.type == "new_blind_choice" then
			G.CONTROLLER.locks[lock] = true
			tag:yep('+', G.C.ORANGE,function() 
				local key = 'p_toga_togaziparchivepack'
				local card = Card(G.play.T.x + G.play.T.w/2 - G.CARD_W*1.27/2,
				G.play.T.y + G.play.T.h/2-G.CARD_H*1.27/2, G.CARD_W*1.27, G.CARD_H*1.27, G.P_CARDS.empty, G.P_CENTERS[key], {bypass_discovery_center = true, bypass_discovery_ui = true})
				card.cost = 0
				card.from_tag = true
				G.FUNCS.use_card({config = {ref_table = card}})
				card:start_materialize()
				G.CONTROLLER.locks[lock] = nil
				return true
			end)
			tag.triggered = true
			return true
		end
	end,
}

SMODS.Tag{
	key = "thespbroll",
	atlas = "TOGATags",
	pos = { x = 2, y = 0 },
	config = { type = "immediate" },
	in_pool = function(self, args)
		return true
	end,
	apply = function(self, tag, context)
		local lock = tag.ID
		if context.type == "immediate" then
			G.CONTROLLER.locks[lock] = true
			tag:yep('+', G.C.ORANGE,function() 
				local card = create_card('Spectral', G.consumeables, nil, nil, nil, nil, "c_toga_selfpropelledbomb", "thespbrun")
				card:add_to_deck()
				G.consumeables:emplace(card)
				G.CONTROLLER.locks[lock] = nil
				return true
			end)
			tag.triggered = true
			return true
		end
	end,
}

SMODS.Tag{
	key = "guaranteedice",
	atlas = "TOGATags",
	pos = { x = 3, y = 0 },
	config = { type = "store_joker_create" },
	in_pool = function(self, args)
		if #SMODS.find_card('j_oops', true) > 0 then return false
		else return true end
	end,
	min_ante = 3,
	apply = function(self, tag, context)
		if context.type == "store_joker_create" then
			local card = create_card("Joker", context.area, nil, nil, nil, nil, "j_oops")
			create_shop_card_ui(card, "Joker", context.area)
			card.states.visible = false
			tag:yep("+", G.C.RED, function()
				card:start_materialize()
				card:set_cost()
				return true
			end)
			tag.triggered = true
			return card
		end
	end,
}

SMODS.Tag{
	key = "thenet",
	atlas = "TOGATags",
	pos = { x = 4, y = 0 },
	config = { type = "immediate" },
	in_pool = function(self, args)
		return true
	end,
	apply = function(self, tag, context)
		local lock = tag.ID
		if context.type == "immediate" then
			G.CONTROLLER.locks[lock] = true
			tag:yep('+', G.C.ORANGE,function() 
				local card = create_card('Spectral', G.consumables, nil, nil, nil, nil, "c_black_hole", "internetexplorer")
				card:add_to_deck()
				G.consumeables:emplace(card)
				G.CONTROLLER.locks[lock] = nil
				return true
			end)
			tag.triggered = true
			return true
		end
	end,
}

SMODS.Tag{
	key = "controlexe",
	atlas = "TOGATags",
	pos = { x = 5, y = 0 },
	config = { type = "immediate" },
	in_pool = function(self, args)
		return true
	end,
	apply = function(self, tag, context)
		local lock = tag.ID
		if context.type == "immediate" then
			if #G.jokers.cards > 0 then
				local jokerlist, itercount, iterlimit = G.jokers.cards, 0, 64
				local seljoker = pseudorandom_element(jokerlist, pseudoseed('controlpanel'))
				while seljoker.edition and itercount < iterlimit do
					itercount = itercount + 1
					seljoker = pseudorandom_element(jokerlist, pseudoseed('controlpanel'))
				end
				
				if not seljoker.edition then
					G.CONTROLLER.locks[lock] = true
					tag:yep('+', G.C.ORANGE,function() 
						local seledition = poll_edition('98se', nil, false, true)
						seljoker:set_edition(seledition, true)
						G.CONTROLLER.locks[lock] = nil
						return true
					end)
				else
					tag:nope()
				end
			else
				tag:nope()
			end
			tag.triggered = true
			return true
		end
	end,
}

SMODS.Tag{
	key = "thelegend",
	atlas = "TOGATags",
	pos = { x = 7, y = 0 },
	config = { type = "store_joker_create" },
	min_ante = 2,
	apply = function(self, tag, context)
		if context.type == "store_joker_create" then
			local card = create_card("Joker", context.area, true)
			create_shop_card_ui(card, "Joker", context.area)
			card.states.visible = false
			tag:yep("+", G.C.ORANGE, function()
				card:start_materialize()
				card:set_cost()
				return true
			end)
			tag.triggered = true
			return card
		end
	end,
}

SMODS.Back{
	key = "frogdeck",
	pos = { x = 0, y = 0 },
	atlas = "TOGADeckBack",
	unlocked = true,
	discovered = true,
	config = {ante_scaling = 1.25, hands = -1, discards = -1, joker_slot = 1, consumable_slot = 1, hand_size = 3, dollars = 6, spectral_rate = 1},
	loc_vars = function(self, info_queue, center)
		return { vars = { self.config.hands, self.config.discards, self.config.joker_slot, self.config.consumable_slot, self.config.ante_scaling, self.config.hand_size } }
	end
}

SMODS.Back{
	key = "spacedeck",
	pos = { x = 1, y = 0 },
	atlas = "TOGADeckBack",
	unlocked = true,
	config = {vouchers = {'v_planet_merchant', 'v_planet_tycoon'}, spectral_rate = 1.25, togaspace = true},
	apply = function(self, back)
		if self.config.togaspace then
			G.E_MANAGER:add_event(Event({
				func = function()
					if G.jokers then
						SMODS.add_card({ key = "j_space" })
						return true
					end
				end,
			}))
		end
	end
}

SMODS.Back{
	key = "srb2kartdeck",
	pos = { x = 2, y = 0 },
	atlas = "TOGADeckBack",
	unlocked = true,
	config = {spectral_rate = 1, togakarty = true, joker_slot = -2},
	loc_vars = function(self, info_queue, center)
		return { vars = { self.config.ante_scaling or 1, self.config.joker_slot } }
	end,
	apply = function(self, back)
		if self.config.togakarty then
			G.E_MANAGER:add_event(Event({
				func = function()
					if G.jokers then
						SMODS.add_card({ key = "j_toga_jokersrb2kart", stickers = { "eternal" } })
						return true
					end
				end,
			}))
		end
	end
}

SMODS.Back{
	key = "againdeck",
	pos = { x = 3, y = 0 },
	atlas = "TOGADeckBack",
	unlocked = true,
	config = {joker_slot = -3, ante_scaling = 1.25},
	loc_vars = function(self, info_queue, center)
		return { vars = { self.config.ante_scaling, self.config.joker_slot } }
	end,
	calculate = function(self, card, context)
		if context.cardarea == G.play and context.repetition and not context.repetition_only
		and context.other_card and G.jokers.cards and #G.jokers.cards >= 1 then
			return {
				repetitions = #G.jokers.cards,
				message = localize('k_again_ex'),
				card = context.other_card
			}
		end
	end,
}

SMODS.Back{
	key = "311deck",
	pos = { x = 4, y = 0 },
	atlas = "TOGADeckBack",
	unlocked = true,
	config = { extraante = 3, dollars = 7, reducehandsel = -2, hand_size = 3, pokerhandlvlup = 1},
	loc_vars = function(self, info_queue, center)
		return { vars = { self.config.dollars, self.config.hand_size, self.config.reducehandsel, self.config.extraante, self.config.pokerhandlvlup } }
	end,
	apply = function(self, back)
		G.E_MANAGER:add_event(Event({
			func = function()
				for _, v in ipairs(G.handlist) do
					G.GAME.hands[v].level = G.GAME.hands[v].level + self.config.pokerhandlvlup
					G.GAME.hands[v].mult = math.max(G.GAME.hands[v].s_mult + G.GAME.hands[v].l_mult*(G.GAME.hands[v].level - 1), 1)
					G.GAME.hands[v].chips = math.max(G.GAME.hands[v].s_chips + G.GAME.hands[v].l_chips*(G.GAME.hands[v].level - 1), 0)
					if v ~= "High Card" and v ~= "Pair" and v ~= "Three of a Kind" then
						G.GAME.hands[v].visible = false
					end
				end
				G.GAME.win_ante = G.GAME.win_ante + self.config.extraante
				if G.hand then
					G.hand.config.highlighted_limit = G.hand.config.highlighted_limit + self.config.reducehandsel
					return true
				end
			end,
		}))
	end,
	calculate = function(self, card, context)
		local iter, iterlimit = 0, 100 -- Just so we don't freeze the game.
		while G.GAME.round_resets.blind_choices.Boss == 'bl_psychic' do
			G.GAME.round_resets.blind_choices.Boss = get_new_boss()
			iter = iter + 1
			if togabalatro.config.DoMoreLogging then sendInfoMessage("Iteration "..iter.." of "..iterlimit.." rolling for non-Psychic boss blinds.", "TOGAPack") end
			if iter >= iterlimit then break end
		end
	end
}

SMODS.Back{
	key = "screamingdeck",
	pos = { x = 5, y = 0 },
	atlas = "TOGADeckBack",
	unlocked = true,
	config = {ante_scaling = 1.25, extraante = 3},
	loc_vars = function(self, info_queue, center)
		return { vars = { self.config.ante_scaling, self.config.extraante } }
	end,
	apply = function(self, back)
		G.E_MANAGER:add_event(Event({
			func = function()
				if G.playing_cards then
					local cardtable = {}
					for k, v in ipairs(G.playing_cards) do cardtable[#cardtable+1] = v end
					for i=#cardtable, 1, -1 do
						if cardtable[i].base.id ~= 14 then
							cardtable[i]:remove()
						end
					end
					add_tag(Tag('tag_coupon'))
					play_sound('generic1', 0.9 + math.random()*0.1, 0.8)
					play_sound('holo1', 0.4, 1)
					return true
				end
			end,
		}))
	end
}

SMODS.Voucher{
	key = 'fat32',
	pos = { x = 0, y = 1 },
	atlas = 'TOGAConsumables',
	unlocked = true,
	cost = 16,
	rarity = 4,
	config = { rarity = 4, extra = { h_size_scale = 0.5 } },
	loc_vars = function(self, info_queue, card)
		return {vars = {card.ability.extra.h_size_scale*100}}
	end,
	requires = {'v_paint_brush'},
	redeem = function(self)
		if togabalatro.config.DoMoreLogging then sendInfoMessage("Increased hand size by "..math.ceil(G.hand.config.card_limit*self.config.extra.h_size_scale)..".", "TOGAPack") end
		G.hand:change_size(math.ceil(G.hand.config.card_limit*self.config.extra.h_size_scale))
	end,
}

SMODS.Voucher{
	key = 'diskdefrag',
	pos = { x = 1, y = 1 },
	atlas = 'TOGAConsumables',
	unlocked = true,
	cost = 10,
	rarity = 3,
	config = { rarity = 3, extra = { discards = 1 } },
	loc_vars = function(self, info_queue, card)
		return {vars = {card.ability.extra.discards}}
	end,
	calculate = function(self, card, context)
		if context.after then
			ease_discard(card.ability.extra.discards)
		end
	end,
	redeem = function(self)
		G.GAME.round_resets.discards = G.GAME.round_resets.discards - self.config.extra.discards
		ease_discard(-self.config.extra.discards)
	end,
}

SMODS.Voucher{
	key = 'hardwarewizard',
	pos = { x = 2, y = 1 },
	atlas = 'TOGAConsumables',
	unlocked = true,
	cost = 15,
	rarity = 3,
	config = { rarity = 3, extra = { probabilitymult = 2 } },
	loc_vars = function(self, info_queue, card)
		return {vars = {card.ability.extra.probabilitymult}}
	end,
	redeem = function(self)
		for k, v in pairs(G.GAME.probabilities) do 
			G.GAME.probabilities[k] = v*self.config.extra.probabilitymult
		end
	end,
}

SMODS.Voucher{
	key = 'hardwarewizardxp',
	pos = { x = 2, y = 2 },
	atlas = 'TOGAConsumables',
	unlocked = true,
	cost = 15,
	rarity = 4,
	config = { rarity = 4, extra = { probabilitymult = 2 } },
	loc_vars = function(self, info_queue, card)
		return {vars = {card.ability.extra.probabilitymult}}
	end,
	requires = {'v_toga_hardwarewizard'},
	redeem = function(self)
		for k, v in pairs(G.GAME.probabilities) do 
			G.GAME.probabilities[k] = v*self.config.extra.probabilitymult
		end
	end,
}

SMODS.Voucher{
	key = 'wormsninjarope',
	pos = { x = 0, y = 2 },
	atlas = 'TOGAConsumables',
	unlocked = true,
	cost = 10,
	rarity = 3,
	config = { rarity = 3, extra = { moreselect = 1 } },
	loc_vars = function(self, info_queue, card)
		return {vars = {math.max(1, math.floor(card.ability.extra.moreselect))}}
	end,
	redeem = function(self)
		if togabalatro.config.DoMoreLogging then sendInfoMessage("Increased card selection limit by "..math.max(1, math.floor(self.config.extra.moreselect))..".", "TOGAPack") end
		G.hand.config.highlighted_limit = G.hand.config.highlighted_limit + math.max(1, math.floor(self.config.extra.moreselect))
	end,
}

SMODS.Voucher{
	key = 'wormsscalesofjustice',
	pos = { x = 1, y = 2 },
	atlas = 'TOGAConsumables',
	unlocked = true,
	cost = 15,
	rarity = 3,
	config = { rarity = 3 },
	loc_vars = function(self, info_queue, card)
		info_queue[#info_queue + 1] = {key = "toga_scales1", set = 'Other'}
		info_queue[#info_queue + 1] = {key = "toga_scales2", set = 'Other'}
		info_queue[#info_queue + 1] = {key = "toga_scales3", set = 'Other'}
	end,
	requires = {'v_toga_ninjarope'},
	redeem = function(self)
		-- do the sound!
		play_sound('toga_scalesofjustice')
		-- Joker slots, Consumable slots, hand size, card selection limit.
		local cardlimitavrg = math.floor(((G.jokers and G.jokers.config.card_limit or 5) + (G.hand and G.hand.config.card_limit or 8) + (G.hand and G.hand.config.highlighted_limit or 5) + (G.consumeables and G.consumeables.config.card_limit or 2))/4)
		if togabalatro.config.DoMoreLogging then sendInfoMessage("Resulted average is "..cardlimitavrg..".", "TOGAPack") end
		G.jokers.config.card_limit = cardlimitavrg
		G.consumeables.config.card_limit = cardlimitavrg
		G.hand.config.card_limit = cardlimitavrg
		G.hand.config.highlighted_limit = cardlimitavrg
		-- poker hand levels.
		local totallevel = 0
		for _, v in ipairs(G.handlist) do
			totallevel = totallevel + G.GAME.hands[v].level
		end
		local averagelevel = math.ceil(totallevel / #G.handlist)
		for _, v in ipairs(G.handlist) do
			G.GAME.hands[v].level = math.max(0, averagelevel)
			G.GAME.hands[v].mult = math.max(G.GAME.hands[v].s_mult + G.GAME.hands[v].l_mult*(G.GAME.hands[v].level - 1), 1)
			G.GAME.hands[v].chips = math.max(G.GAME.hands[v].s_chips + G.GAME.hands[v].l_chips*(G.GAME.hands[v].level - 1), 0)
		end
		-- hands and discards
		local dishand = math.floor((G.GAME.round_resets.discards + G.GAME.round_resets.hands)/2)
		
		G.GAME.round_resets.hands = dishand
		local handdiff = math.floor(G.GAME.round_resets.hands-dishand)
		local hand_UI = G.HUD:get_UIE_by_ID('hand_UI_count')
		G.GAME.current_round.hands_left = dishand
		hand_UI.config.object:update()
		
		G.GAME.round_resets.discards = dishand
		local disdiff = math.floor(G.GAME.round_resets.discards-dishand)
		local discard_UI = G.HUD:get_UIE_by_ID('discard_UI_count')
		G.GAME.current_round.discards_left = dishand
		discard_UI.config.object:update()
		
		G.HUD:recalculate()
	end,
}

if Talisman then
	SMODS.Voucher{
		key = 'mspaint',
		pos = { x = 3, y = 1 },
		atlas = 'TOGAConsumables',
		unlocked = true,
		cost = 20,
		rarity = 3,
		config = { rarity = 3, extra = { echip = 1.05, jokerslot = 1 } },
		loc_vars = function(self, info_queue, card)
			return {vars = { card.ability.extra.echip, card.ability.extra.jokerslot }}
		end,
		redeem = function(self)
			G.jokers.config.card_limit = G.jokers.config.card_limit - self.config.extra.jokerslot
		end,
		requires = {'v_paint_brush'},
		calculate = function(self, card, context)
			if context.cardarea == G.hand and context.other_card and not context.repetition and not context.repetition_only and not context.end_of_round and not context.other_card.debuff then
				return {
					card = context.other_card,
					echips = card.ability.extra.echip,
					echip_message = {message = localize{ type = "variable", key = "toga_Echip", vars = { card.ability.extra.echip } }, colour = G.C.DARK_EDITION, sound = "talisman_echip"}
				}
			end
		end,
	}
end

SMODS.Voucher{
	key = 'dataflush',
	pos = { x = 4, y = 1 },
	atlas = 'TOGAConsumables',
	unlocked = true,
	cost = 20,
	rarity = 3,
	config = { rarity = 3 },
	calculate = function(self, card, context)
		if context.pre_discard then
			local _, _, pokerhands = G.FUNCS.get_poker_hand_info(G.hand.highlighted)
			if next(pokerhands['Flush']) and G.consumeables.cards[1] then
				G.E_MANAGER:add_event(Event({
					func = function() 
						local card = copy_card(pseudorandom_element(G.consumeables.cards, pseudoseed('dnsflush')), nil)
						card:set_edition({negative = true}, true)
						card:add_to_deck()
						G.consumeables:emplace(card) 
						return true
					end})
				)
			end
		end
	end,
}

-- Of all things to first do... this?
SMODS.Seal{
	key = 'sealseal',
	badge_colour = HEX("61666D"),
	atlas = "TOGASeals",
	pos = { x = 0, y = 0 },
	sound = { sound = "gold_seal", per = 1.2, vol = 0.4 },
	calculate = function(self, card, context)
		if context.main_scoring and context.cardarea == G.play then
			return {
				func = function()
					G.E_MANAGER:add_event(Event({
						func = function()
							if #G.jokers.cards + G.GAME.joker_buffer < G.jokers.config.card_limit then
								local card = SMODS.create_card({ set = 'Joker', key = 'j_egg' }) -- egg.
								card:add_to_deck()
								G.jokers:emplace(card)
								card:start_materialize()
								G.GAME.joker_buffer = 0
							end
							return true
						end}))
					return true
				end
			}
		end
	end,
}

-- save_run() go brr. Keeping as Experimental for now, despite getting the main function to more or less work.
SMODS.Enhancement{
	key = 'notification',
	atlas = "TOGAEnhancements",
	pos = { x = 0, y = 0 },
	loc_vars = function(self, info_queue, card)
		if not togabalatro.config.Experimentals then info_queue[#info_queue+1] = {key = "toga_experimentalstuffdisabled", set = 'Other'} end
    end,
	in_pool = function()
		return togabalatro.config.Experimentals -- only appear if Experimental objects are enabled
	end,
	calculate = function(self, card, context)
		if not togabalatro.config.Experimentals then return end -- execute only if Experimental objects are enabled
		
		if ((context.other_drawn and (G.STATE == G.STATES.TAROT_PACK or G.STATE == G.STATES.SPECTRAL_PACK or (G.STATE == G.STATES.SMODS_BOOSTER_OPENED and SMODS.OPENED_BOOSTER.config.center.draw_hand)))
		or (context.first_hand_drawn or context.hand_drawn)) and G.deck and #G.deck.cards > 0 and card and context.cardarea == G.deck then
			draw_card(G.deck, G.hand, nil, "up", true, card)
			G.E_MANAGER:add_event(Event({
				func = function() 
					save_run() -- god.
					return true
				end})
			)
		end
	end,
	set_badges = function(self, card, badges)
        badges[#badges+1] = create_badge(localize('toga_experimental'), G.C.RED, G.C.WHITE, 0.8)
    end,
}